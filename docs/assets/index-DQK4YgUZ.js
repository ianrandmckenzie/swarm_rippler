var Ie=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var st=Ie((ct,G)=>{(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();class ge{constructor(){this.themes=["light","dark","system"],this.currentTheme="system",this.init()}async init(){await this.loadThemePreference(),this.applyTheme(this.currentTheme),this.setupEventListeners(),this.setupSystemThemeListener(),this.updateThemeButtons()}async loadThemePreference(){try{const t=await getPreferences();this.currentTheme=t.theme||"system"}catch{console.log("No stored theme preference, using system default"),this.currentTheme="system"}}async saveThemePreference(t){try{const e=await getPreferences();e.theme=t,await savePreferences(e)}catch(e){console.error("Failed to save theme preference:",e)}}setupEventListeners(){document.querySelectorAll("button[data-theme]").forEach(e=>{const i=e.dataset.theme;e.addEventListener("click",o=>{const s=o.currentTarget.dataset.theme;this.setTheme(s),window.innerWidth<640&&this.showMobileTooltip(e,s)}),e.addEventListener("mouseenter",o=>{window.innerWidth>=640&&this.showThemeTooltip(o.currentTarget,i)}),e.addEventListener("mouseleave",()=>{window.innerWidth>=640&&this.hideTooltip()})})}setupSystemThemeListener(){window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{this.currentTheme==="system"&&this.applySystemTheme()})}async setTheme(t){this.themes.includes(t)&&(this.currentTheme=t,await this.saveThemePreference(t),this.applyTheme(t),this.updateThemeButtons())}applyTheme(t){const e=document.documentElement;e.classList.remove("dark","light"),t==="dark"?e.classList.add("dark"):t==="light"?e.classList.add("light"):t==="system"&&this.applySystemTheme(),this.updateMetaThemeColor(t),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}applySystemTheme(){const t=document.documentElement,e=window.matchMedia("(prefers-color-scheme: dark)").matches;t.classList.remove("dark","light"),e?t.classList.add("dark"):t.classList.add("light"),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}updateMetaThemeColor(t){const e=document.querySelector('meta[name="theme-color"]'),i=document.querySelector('meta[name="msapplication-TileColor"]');let o;t==="dark"||t==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches?o="#232323":o="#1F1F1F",e&&e.setAttribute("content",o),i&&i.setAttribute("content",o)}updateThemeButtons(){document.querySelectorAll("button[data-theme]").forEach(e=>{if(e.classList.remove("bg-swarmshadow-200","text-swarmlight-100","ring-2","ring-swarmlight-300","bg-swarmlight-300","text-swarmshadow-200","ring-swarmshadow-200","bg-swarmlight-200","text-black","text-white","font-semibold"),e.classList.remove("active"),e.dataset.theme===this.currentTheme){const i=e.dataset.theme,o=document.documentElement.classList.contains("dark");i==="dark"?e.classList.add("bg-swarmshadow-200","text-swarmlight-100"):i==="light"?e.classList.add("bg-swarmlight-300","text-swarmshadow-200"):i==="system"&&(e.classList.add("ring-2","font-semibold"),o?(e.classList.add("text-white","ring-swarmlight-600","dark:hover:text-swarmlight-50"),e.classList.remove("dark:hover:text-black")):e.classList.add("text-black","ring-swarmlight-300"),o?e.style.background="linear-gradient(45deg, #706A43 50%, #232323 50%)":e.style.background="linear-gradient(45deg, #FFFDE7 50%, #FFEE58 50%)"),i!=="system"&&(e.classList.add("ring-2"),o?e.classList.add("ring-swarmlight-600"):e.classList.add("ring-swarmlight-300"))}else e.dataset.theme==="system"&&(e.classList.add("dark:hover:text-black"),e.classList.remove("dark:hover:text-swarmlight-50"),e.style.background="")})}getCurrentTheme(){return this.currentTheme}getEffectiveTheme(){return this.currentTheme==="system"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":this.currentTheme}getThemeDescription(t){switch(t){case"light":return"Light theme - bright interface";case"dark":return"Dark theme - dark interface";case"system":return"System theme - follows your device settings";default:return"Theme option"}}showThemeTooltip(t,e){const i=this.getThemeDescription(e);if(window.showTooltip){const s=t.closest(".theme-switcher")||t;window.showTooltip(i,s,0)}}showMobileTooltip(t,e){const i=this.getThemeDescription(e);if(window.showTooltip){const s=t.closest(".theme-switcher")||t;window.showTooltip(i,s,0),setTimeout(()=>{window.hideTooltip&&window.hideTooltip()},2e3)}}hideTooltip(){window.hideTooltip&&window.hideTooltip()}}document.addEventListener("DOMContentLoaded",()=>{window.themeManager=new ge});typeof G<"u"&&G.exports&&(G.exports=ge);const R=document.getElementById("tooltip");function we(n,t,e=0){const i=t.getBoundingClientRect(),o=window.innerWidth,s=window.innerHeight;R.textContent=n;const a=t.closest("#sequenceModal")!==null;let l,c;if(a||o<640){const r=R.offsetWidth||200;if(a){const u=document.getElementById("modalContent").getBoundingClientRect();l=u.left+(u.width-r)/2,c=u.top-40,c<16&&(c=u.top+8)}else l=(o-r)/2,c=i.bottom+8;l=Math.max(8,Math.min(l,o-r-8)),c=Math.max(8,Math.min(c,s-50))}else{l=i.left+i.width/2-R.offsetWidth/2+e,c=i.bottom+16;const r=R.offsetWidth||200;l=Math.max(8,Math.min(l,o-r-8))}R.style.left=l+"px",R.style.top=c+"px",R.classList.remove("hidden"),R.removeAttribute("aria-hidden")}function ye(){R.classList.add("hidden"),R.setAttribute("aria-hidden","true")}window.showTooltip=we;window.hideTooltip=ye;window.showTooltip=we;window.hideTooltip=ye;async function pe(n){const t=document.getElementById("sequenceBar"),e=80,i=document.createElement("canvas");i.width=e*dpr,i.height=e*dpr,i.style.width=e+"px",i.style.height=e+"px";const o=i.getContext("2d");o.scale(dpr,dpr);let s,a,l;Array.isArray(n)?(s=n,a=!1,l=3):(s=n.sequence||n,a=n.isLoop||!1,l=n.loopInterval||3);const c=3,r=e-c,d=e/2,u=e/2,m=r*.08,f=m*.35,w=m*1.8;o.beginPath(),o.arc(d,u,m,0,2*Math.PI);const y=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";if(o.fillStyle=y,o.fill(),smallCircles.forEach(({dirX:S,dirY:v,audio:x},I)=>{for(let M=1;M<=3;M++){const V=[0,1,2,3,4,5,7,6].indexOf(I)*3+(M-1),be=s.includes(V),Z=d+S*w*M,ee=u+v*w*M;if(Z-f>=c&&Z+f<=e-c&&ee-f>=c&&ee+f<=e-c){o.beginPath(),o.arc(Z,ee,f,0,2*Math.PI);const de=window.themeManager?window.themeManager.getEffectiveTheme():"light",ke=de==="dark"?"#fff":"#000",Ce=de==="dark"?"#000":"#fff";o.fillStyle=ke,o.strokeStyle=Ce,o.lineWidth=.5,be?o.fill():o.stroke()}}}),i.sequenceData={seq:s,isLoop:a,loopInterval:l},window.audioSystem&&window.audioSystem.isSequenceLooping&&window.audioSystem.isSequenceLooping(s)){const S=document.documentElement.classList.contains("dark");i.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","p-2"),S?i.classList.add("bg-swarmshadow-50"):i.classList.add("bg-swarmstripe-200/50"),i.style.animation="loop-pulse 2s ease-in-out infinite"}t.appendChild(i)}function ne(){if(typeof loadAllSequences>"u"||typeof smallCircles>"u"||typeof dpr>"u"){setTimeout(ne,10);return}loadAllSequences().then(n=>{n.forEach(t=>pe(t)),console.log(`✅ Loaded ${n.length} saved sequences`)}).catch(n=>{console.error("Failed to load sequences:",n)})}function Re(){document.getElementById("sequenceBar").querySelectorAll("canvas").forEach(e=>e.remove()),loadAllSequences().then(e=>{e.forEach(i=>pe(i))}).catch(e=>{console.error("Failed to reload sequences after theme change:",e)})}document.addEventListener("DOMContentLoaded",()=>{if(window.themeManager){const n=window.themeManager.setTheme.bind(window.themeManager);window.themeManager.setTheme=async function(t){await n(t),Re()}}});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ne):ne();const oe={ZERO:0,ONE:.25,TWO:.5,THREE:.75},Ae=.01;let te=null;function Se(){return te||(te=new(window.AudioContext||window.webkitAudioContext)),te}function Te(n){const t=Math.floor(n/3),e=n%3;return{radian:e+1,direction:t,position:e}}function Be(n){const t=Math.floor(n/3);return typeof smallCircles<"u"&&smallCircles[t]?smallCircles[t].audio:null}function De(){if(typeof ripples<"u"&&typeof canvas<"u"){const n=canvas.clientWidth/2,t=canvas.clientHeight/2,o=Math.min(canvas.clientWidth,canvas.clientHeight)*.15*.4;ripples.push({x:n,y:t,radius:o,alpha:1})}}async function j(n,t={}){if(!n||n.length===0){console.warn("No sequence to play");return}const{inModal:e=!1}=t,i=Se();i.state==="suspended"&&await i.resume(),window.canvasHighlight&&window.canvasHighlight.clearAllHighlights(),e&&window.modalHighlight&&window.modalHighlight.clearModalHighlights();const o={0:[],1:[],2:[],3:[]};n.forEach(s=>{const{radian:a}=Te(s);o[a].push(s)}),De(),e&&window.modalHighlight&&window.modalHighlight.createModalRipple(),typeof dropletSound<"u"&&setTimeout(()=>{dropletSound.currentTime=0,dropletSound.play().catch(s=>console.warn("Failed to play droplet sound:",s)),window.canvasHighlight&&window.canvasHighlight.highlightCircle(-1,400),e&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(-1,400)},0),Object.keys(o).forEach(s=>{const a=o[s];if(a.length===0)return;const l=parseInt(s),c=oe[Object.keys(oe)[l]]*1e3;a.forEach((r,d)=>{const u=Be(r);if(u){const m=c+d*Ae*1e3;setTimeout(()=>{u.currentTime=0,u.play().catch(f=>console.warn(`Failed to play audio for circle ${r}:`,f)),window.canvasHighlight&&window.canvasHighlight.highlightCircle(r,600),e&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(r,600)},m)}})})}const J=5;let P=new Map;function Me(n){return JSON.stringify(n)}function le(n,t){const e=Me(n);if(P.has(e)){const i=P.get(e);clearInterval(i.timer),P.delete(e),console.log("🔄 Loop playback stopped for sequence:",e.substring(0,50)+"..."),ie(),N()}else{if(P.size>=J){console.warn(`🔄 Maximum number of concurrent loops (${J}) reached. Cannot start new loop.`);const o=document.getElementById("loopCounter");if(o){const s=o.className;o.className=o.className.replace(/bg-\S+/g,"bg-red-200 dark:bg-red-800"),o.style.animation="pulse 0.5s ease-in-out 2",setTimeout(()=>{o.className=s,o.style.animation=""},1e3)}return}console.log(`🔄 Starting loop playback every ${t}s`),j(n);const i=setInterval(async()=>{try{await j(n)}catch(o){console.error("Error in loop playback:",o),le(n,t)}},t*1e3);P.set(e,{timer:i,sequence:n,interval:t}),ie(),N()}}function ve(n){if(!n)return!1;const t=Me(n);return P.has(t)}function N(){const n=document.getElementById("loopCounter");if(!n)return;const t=P.size;t>0?(n.textContent=`Loops playing: ${t}/${J}`,n.classList.remove("hidden")):n.classList.add("hidden")}function ie(){const n=document.getElementById("sequenceBar");if(!n)return;n.querySelectorAll("canvas").forEach(e=>{const i=e.sequenceData;if(i){const o=ve(i.seq),s=document.documentElement.classList.contains("dark");e.classList.remove("bg-swarmstripe-200/50","bg-swarmshadow-50","rounded-lg","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),e.style.backgroundColor="",e.style.animation="",o&&(e.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),s?e.classList.add("bg-swarmshadow-50"):e.classList.add("bg-swarmstripe-200/50"),e.style.animation="loop-pulse 2s ease-in-out infinite")}})}function se(){if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",se);return}const n=document.getElementById("sequenceBar");if(!n){console.warn("Sequence bar not found, retrying..."),setTimeout(se,100);return}n.addEventListener("click",async t=>{const e=t.target.closest("canvas");if(!e)return;let i;if(e.sequenceData)i=e.sequenceData;else{const l=Array.from(n.children).indexOf(e);try{i=(await loadAllSequences())[l]}catch(c){console.error("Error loading sequence:",c);return}}if(!i)return;let o,s,a;Array.isArray(i)?(o=i,s=!1,a=3):(o=i.seq||i.sequence,s=i.isLoop||!1,a=i.loopInterval||3);try{s?le(o,a):await j(o)}catch(l){console.error("Error playing sequence:",l)}})}se();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N();window.audioSystem={playSequence:j,initAudioContext:Se,toggleLoopPlayback:le,isSequenceLooping:ve,updateThumbnailLoopStates:ie,updateLoopCounter:N,getRadianInfo:Te,RADIAN_TIMING:oe,MAX_CONCURRENT_LOOPS:J,getActiveLoopCount:()=>P.size};class xe{constructor(){this.contextMenu=null,this.currentThumbnail=null,this.init()}init(){this.contextMenu=document.getElementById("contextMenu"),this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",e=>{this.contextMenu.contains(e.target)||this.hideContextMenu()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.hideContextMenu()}),document.getElementById("editSequence").addEventListener("click",()=>{this.editSequence(),this.hideContextMenu()}),document.getElementById("deleteSequence").addEventListener("click",()=>{this.deleteSequence(),this.hideContextMenu()});const t=document.getElementById("sequenceBar");t&&t.addEventListener("contextmenu",e=>{const i=e.target.closest("canvas");i&&i.sequenceData&&(e.preventDefault(),this.showContextMenu(e,i))})}showContextMenu(t,e){this.currentThumbnail=e,this.contextMenu.style.visibility="hidden",this.contextMenu.classList.remove("hidden");const i=this.contextMenu.getBoundingClientRect(),o=i.width,s=i.height,a=window.innerWidth,l=window.innerHeight;let c=t.clientX,r=t.clientY;const d=8;c+o+d>a&&(c=c-o,c<d&&(c=a-o-d)),c=Math.max(d,c),r+s+d>l&&(r=r-s,r<d&&(r=l-s-d)),r=Math.max(d,r);const u=document.getElementById("sequenceBar");if(u){const m=u.getBoundingClientRect();t.clientY>=m.top&&r+s>m.top&&(r=Math.max(d,m.top-s-4))}this.contextMenu.style.left=c+"px",this.contextMenu.style.top=r+"px",this.contextMenu.style.visibility="visible"}hideContextMenu(){this.contextMenu.classList.add("hidden"),this.contextMenu.style.visibility="",this.currentThumbnail=null}editSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const t=this.currentThumbnail.sequenceData;this.currentThumbnail.setAttribute("data-editing","true"),window.modalManager&&window.modalManager.openEditMode(t,this.currentThumbnail)}async deleteSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const t=this.currentThumbnail,e=this.currentThumbnail.sequenceData;if(confirm("Are you sure you want to delete this sequence? This action cannot be undone."))try{const s=(await loadAllSequences()).findIndex(a=>{const l=Array.isArray(a)?a:a.sequence||a.seq,c=Array.isArray(e)?e:e.sequence||e.seq;return JSON.stringify(l)===JSON.stringify(c)});if(s!==-1){if(await deleteSequence(s),t.remove(),window.audioSystem&&window.audioSystem.isSequenceLooping){const a=Array.isArray(e)?e:e.sequence||e.seq;if(window.audioSystem.isSequenceLooping(a)){const l=e.loopInterval||3;window.audioSystem.toggleLoopPlayback(a,l)}}console.log("✅ Sequence deleted successfully")}else console.error("❌ Sequence not found in storage"),alert("Sequence not found in storage. It may have already been deleted.")}catch(o){console.error("❌ Failed to delete sequence:",o),alert("Failed to delete sequence. Please try again.")}}}document.addEventListener("DOMContentLoaded",()=>{window.contextMenuManager=new xe});window.ContextMenuManager=xe;const E=document.getElementById("soundCanvas"),g=E.getContext("2d"),z=window.devicePixelRatio||1;let D=new Map;const he=new Audio("./assets/5.mp3"),Pe=[{dirX:0,dirY:-1,audio:new Audio("./assets/2.mp3")},{dirX:0,dirY:1,audio:new Audio("./assets/8.mp3")},{dirX:-1,dirY:0,audio:new Audio("./assets/4.mp3")},{dirX:1,dirY:0,audio:new Audio("./assets/6.mp3")},{dirX:1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/3.mp3")},{dirX:-1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/1.mp3")},{dirX:-1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/7.mp3")},{dirX:1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/9.mp3")}];function Qe(){const n=E.clientWidth,t=E.clientHeight;E.width=n*z,E.height=t*z,g.resetTransform(),g.scale(z,z)}function He(){Qe();const n=E.clientWidth,t=E.clientHeight,e=n/2,i=t/2,o=Math.min(n,t),s=.4,a=o*.15*s,l=a*.4,c=a+l+o*.12*s;if(g.clearRect(0,0,n,t),g.beginPath(),g.arc(e,i,a,0,Math.PI*2),g.lineWidth=l,D.has(-1)){const{startTime:d,duration:u}=D.get(-1),m=ue(d,u);if(m>0){const f=Math.floor(255*m),w=Math.floor(107*m),p=Math.floor(107*m);g.strokeStyle=`rgb(${f}, ${w}, ${p})`}else{const f=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.strokeStyle=f==="dark"?"#fff":"#000",D.delete(-1)}}else{const d=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.strokeStyle=d==="dark"?"#fff":"#000"}g.stroke(),[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((d,u)=>{for(let m=1;m<=3;m++){const f=e+d.x*c*m,w=i+d.y*c*m,p=u*3+(m-1);if(g.beginPath(),g.arc(f,w,l,0,Math.PI*2),D.has(p)){const{startTime:y,duration:S}=D.get(p),v=ue(y,S);if(v>0){const x=Math.floor(255*v),I=Math.floor(107*v),M=Math.floor(107*v);g.fillStyle=`rgb(${x}, ${I}, ${M})`,g.fill(),g.strokeStyle="#fff",g.lineWidth=2,g.stroke()}else{D.delete(p);const x=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.fillStyle=x==="dark"?"#fff":"#000",g.fill()}}else{const y=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.fillStyle=y==="dark"?"#fff":"#000",g.fill()}}})}const ae=[],Oe=.006,$e=.016;E.addEventListener("click",n=>{const t=E.getBoundingClientRect(),e=E.clientWidth,i=E.clientHeight,o=n.clientX-t.left,s=n.clientY-t.top,a=e/2,l=i/2,c=Math.min(e,i),r=.4,d=c*.15*r;if((o-a)**2+(s-l)**2<=d*d){ae.push({x:a,y:l,radius:d,alpha:1}),he.currentTime=0,he.play();return}const u=d*.4,m=d+u+c*.12*r;for(const{dirX:f,dirY:w,audio:p}of Pe)for(let y=1;y<=3;y++){const S=a+f*m*y,v=l+w*m*y;if((o-S)**2+(s-v)**2<=u*u){p.currentTime=0,p.play();return}}});function We(){const t=Math.min(E.clientWidth,E.clientHeight)*Oe,i=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"255,255,255":"0,0,0";ae.forEach((o,s)=>{g.beginPath(),g.arc(o.x,o.y,o.radius,0,Math.PI*2),g.strokeStyle=`rgba(${i},${o.alpha})`,g.lineWidth=2,g.stroke(),o.radius+=t,o.alpha-=$e,o.alpha<=0&&ae.splice(s,1)})}function Ee(){He(),We(),requestAnimationFrame(Ee)}function Ne(n,t=500){const e=Date.now();D.set(n,{startTime:e,duration:t})}function Fe(){D.clear()}window.canvasHighlight={highlightCircle:Ne,clearAllHighlights:Fe};function ue(n,t){const e=Date.now()-n,i=Math.min(e/t,1),o=4,s=Math.max(0,1-i),a=Math.sin(e*o/100)*.3+.7;return s*a}Ee();const U=document.getElementById("createSequenceBtn"),A=document.getElementById("sequenceModal"),q=document.getElementById("sequenceCanvas"),h=q.getContext("2d"),me=document.getElementById("modalTitle");let B=new Map,F=[];const Xe=4,Ye=.04;class ze{constructor(){this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,this.init()}init(){this.setupEventListeners()}setupEventListeners(){U.addEventListener("click",()=>{this.openCreateMode()})}async openCreateMode(){hideTooltip(),U.classList.remove("highlight-once"),document.body.classList.remove("tutorial-active"),this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,me.textContent="Create New Sequence",b=!await getSetting("tutorialSeen"),b?(_.classList.remove("hidden"),Ge.textContent=W,qe.textContent="0"):_.classList.add("hidden"),this.resetModalState(),this.showModal()}openEditMode(t,e){this.isEditMode=!0,this.editingThumbnail=e,this.originalSequenceData=JSON.parse(JSON.stringify(t)),me.textContent="Edit Sequence",b=!1,_.classList.add("hidden"),this.resetModalState(),this.showModal(),this.loadSequenceIntoModal(t),Y(),ce()}resetModalState(){L.forEach(e=>{e.clicked=!1}),O.checked=!1,Q.value=3,X.style.opacity="0.5",Q.disabled=!0,B.clear(),F.length=0;const t=document.getElementById("modalInstruction");t&&t.classList.add("hidden")}loadSequenceIntoModal(t){const e=Array.isArray(t)?t:t.seq||t.sequence||[],i=t.isLoop||!1,o=t.loopInterval||3;O.checked=i,Q.value=o,i&&(X.style.opacity="1",Q.disabled=!1),e.forEach(s=>{L[s]&&(L[s].clicked=!0)})}showModal(){A.classList.remove("hidden"),A.classList.add("flex"),A.setAttribute("aria-hidden","false"),this.initializeModalCircles(),Y(),re(),b&&Le(),ce()}initializeModalCircles(){const t=q.clientWidth,e=q.clientHeight,i=250,o=(t-i)/2,s=(e-i)/2,a=i/2,l=i/2,c=i*.09,r=c*.3,d=c+r*2,u=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}];L=[],u.forEach((m,f)=>{const w=[0,1,2,3,4,5,7,6],p=smallCircles[w[f]].audio;for(let y=1;y<=3;y++)L.push({x:o+a+m.x*d*y,y:s+l+m.y*d*y,r,audio:p,clicked:!1})})}}function _e(){const n=q.clientWidth,t=q.clientHeight;q.width=n*dpr,q.height=t*dpr,h.resetTransform(),h.scale(dpr,dpr)}const C=document.getElementById("testSequenceBtn"),H=document.getElementById("saveSequenceBtn"),_=document.getElementById("tutorialCounter"),Ge=document.getElementById("targetCount"),qe=document.getElementById("selectedCount"),O=document.getElementById("loopToggle"),Q=document.getElementById("loopInterval"),X=document.getElementById("loopIntervalControls");let L=[],b=!1;const W=5;async function je(){try{const n=await getSetting("tutorialSeen"),t=await loadAllSequences();!n&&t.length===0&&(document.body.classList.add("tutorial-active"),U.classList.add("highlight-once"),showTooltip("Start playing by clicking New Sequence!",U))}catch(n){console.log("Could not check tutorial state:",n)}}setTimeout(je,100);const T=new ze;window.modalManager=T;function Y(){_e();const n=q.clientWidth,t=q.clientHeight,e=Math.min(250,250);h.clearRect(0,0,n,t),h.save();const i=(n-e)/2,o=(t-e)/2;h.translate(i,o);const s=e/2,a=e/2;Je();const l=e*.09;if(h.beginPath(),h.arc(s,a,l,0,2*Math.PI),B.has(-1)){const{startTime:u,duration:m}=B.get(-1),f=fe(u,m);if(f>0){const w=Math.floor(255*f),p=Math.floor(107*f),y=Math.floor(107*f);h.fillStyle=`rgb(${w}, ${p}, ${y})`}else{const w=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.fillStyle=w==="dark"?"#fff":"#000",B.delete(-1)}}else{const u=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.fillStyle=u==="dark"?"#fff":"#000"}h.fill();const c=l*.3,r=l+c*2;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((u,m)=>{var f;for(let w=1;w<=3;w++){const p=s+u.x*r*w,y=a+u.y*r*w,S=m*3+(w-1);h.beginPath(),h.arc(p,y,c,0,2*Math.PI);const v=(f=L[S])==null?void 0:f.clicked;if(B.has(S)){const{startTime:x,duration:I}=B.get(S),M=fe(x,I);if(M>0){const $=Math.floor(255*M),k=Math.floor(107*M),V=Math.floor(107*M);h.fillStyle=`rgb(${$}, ${k}, ${V})`,h.fill(),h.strokeStyle="#fff",h.lineWidth=2,h.stroke()}else{B.delete(S);const k=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";v?(h.fillStyle=k,h.fill()):(h.strokeStyle=k,h.lineWidth=2,h.stroke())}}else{const I=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";v?(h.fillStyle=I,h.fill()):(h.strokeStyle=I,h.lineWidth=2,h.stroke())}}}),h.restore()}function Je(n,t,e,i){const s=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"255,255,255":"0,0,0";F.forEach((a,l)=>{h.beginPath(),h.arc(a.x,a.y,a.radius,0,Math.PI*2),h.strokeStyle=`rgba(${s},${a.alpha})`,h.lineWidth=2,h.stroke(),a.radius+=Xe,a.alpha-=Ye,a.alpha<=0&&F.splice(l,1)})}function Ue(n,t=600){const e=Date.now();B.set(n,{startTime:e,duration:t})}function Ke(){B.clear()}function Ve(){F.push({x:125,y:125,radius:22.5,alpha:1})}function re(){A.classList.contains("hidden")||(Y(),requestAnimationFrame(re))}window.modalHighlight={highlightModalCircle:Ue,clearModalHighlights:Ke,createModalRipple:Ve,startAnimation:re};q.addEventListener("click",async n=>{const t=q.getBoundingClientRect(),e=n.clientX-t.left,i=n.clientY-t.top,o=q.clientWidth,s=q.clientHeight,a=250,l=(o-a)/2,c=(s-a)/2,r=e-l,d=i-c,u=a/2,m=a/2,f=a*.09,w=f*.3,p=f+w*2;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((S,v)=>{for(let x=1;x<=3;x++){const I=u+S.x*p*x,M=m+S.y*p*x,$=v*3+(x-1),k=L[$];if(k&&!k.clicked&&(r-I)**2+(d-M)**2<=w*w){k.clicked=!0,k.audio.currentTime=0,k.audio.play(),ce(),Y();return}}})});function ce(){const n=L.filter(t=>t.clicked).length;b?(n===W?(C.disabled=!1,C.classList.add("highlight-once"),showTooltip("Click Test to hear what your sequence sounds like!",C)):(C.disabled=!0,C.classList.remove("highlight-once")),Le()):n>0?(C.disabled=!1,H.disabled=!1):(C.disabled=!0,H.disabled=!0)}function Le(){if(!b)return;const n=L.filter(e=>e.clicked).length;qe.textContent=n;const t=document.getElementById("modalInstruction");if(n===0)t.textContent="Click the empty circles to form your sequence",t.classList.remove("hidden"),hideTooltip();else if(n<W){const e=W-n;t.textContent=`Select ${e} more circle${e===1?"":"s"}`,t.classList.remove("hidden"),hideTooltip()}else n===W&&(t.classList.add("hidden"),hideTooltip())}C.addEventListener("click",async n=>{hideTooltip(),C.classList.remove("highlight-once");const t=L.map((e,i)=>e.clicked?i:null).filter(e=>e!==null);if(t.length>0)try{window.audioSystem&&window.audioSystem.playSequence?await window.audioSystem.playSequence(t,{inModal:!0}):console.warn("Audio system not available, falling back to basic feedback"),b&&(H.disabled=!1),b&&(await setSetting("tutorialSeen",!0),b=!1)}catch(e){console.error("Error playing test sequence:",e),b&&(H.disabled=!1)}});O.addEventListener("change",()=>{const n=O.checked;Q.disabled=!n,n?X.classList.remove("opacity-50"):X.classList.add("opacity-50")});H.addEventListener("click",async()=>{const n=L.map((o,s)=>o.clicked?s:null).filter(o=>o!==null),t=O.checked,e=parseInt(Q.value)||3,i={sequence:n,isLoop:t,loopInterval:e};try{if(T.isEditMode){const o=await loadAllSequences(),s=Array.isArray(T.originalSequenceData)?T.originalSequenceData:T.originalSequenceData.sequence||T.originalSequenceData.seq,a=o.findIndex(l=>{const c=Array.isArray(l)?l:l.sequence||l.seq;return JSON.stringify(c)===JSON.stringify(s)});if(a!==-1){if(await updateSequence(a,i),window.audioSystem&&window.audioSystem.isSequenceLooping&&window.audioSystem.isSequenceLooping(s)){const l=T.originalSequenceData.loopInterval||3;window.audioSystem.toggleLoopPlayback(s,l)}T.editingThumbnail.removeAttribute("data-editing"),T.editingThumbnail.remove(),addSequenceThumbnail(i),console.log("✅ Sequence updated successfully")}else throw new Error("Original sequence not found in storage")}else await saveSequenceToDB(i),addSequenceThumbnail(i),console.log("✅ New sequence saved successfully");b&&await setSetting("tutorialSeen",!0),K()}catch(o){console.error("❌ Failed to save sequence:",o),alert("Failed to save sequence. Please try again.")}});function K(){hideTooltip(),A.classList.add("hidden"),A.classList.remove("flex"),A.setAttribute("aria-hidden","true"),T.isEditMode&&T.editingThumbnail&&T.editingThumbnail.removeAttribute("data-editing"),T.isEditMode=!1,T.editingThumbnail=null,T.originalSequenceData=null,L.forEach(t=>t.clicked=!1),C.disabled=!0,C.classList.remove("highlight-once"),H.disabled=!0,_.classList.add("hidden"),b=!1;const n=document.getElementById("modalInstruction");n&&n.classList.add("hidden"),O.checked=!1,Q.value=3,Q.disabled=!0,X.style.opacity="0.5",window.modalHighlight&&window.modalHighlight.clearModalHighlights(),F.length=0,Y()}const Ze=document.getElementById("closeModalBtn");Ze.addEventListener("click",K);A.addEventListener("click",n=>{n.target===A&&K()});const et=document.getElementById("modalContent");et.addEventListener("click",n=>{n.stopPropagation()});document.addEventListener("keydown",n=>{n.key==="Escape"&&!A.classList.contains("hidden")&&K()});function fe(n,t){const e=Date.now()-n,i=Math.min(e/t,1),o=4,s=Math.max(0,1-i),a=Math.sin(e*o/100)*.3+.7;return s*a}async function tt(){console.warn("🗑️ Clearing all IndexedDB data for clicking_glossolalia project...");try{const n=await openDB();await n.transaction("sequences","readwrite").objectStore("sequences").clear(),await n.transaction("settings","readwrite").objectStore("settings").clear(),console.log("✅ All IndexedDB data cleared successfully"),confirm("Data cleared! Reload page to reset UI?")&&window.location.reload()}catch(n){console.error("❌ Error clearing IndexedDB data:",n)}}async function nt(){console.warn("🎓 Resetting tutorial state...");try{await setSetting("tutorialSeen",!1),console.log("✅ Tutorial state reset - reload page to see tutorial"),confirm("Tutorial reset! Reload page to see tutorial?")&&window.location.reload()}catch(n){console.error("❌ Error resetting tutorial:",n)}}window.clearAllData=tt;window.resetTutorial=nt;console.log("🔧 Dev helpers available:");console.log("  - clearAllData(): Clear all sequences and settings");console.log("  - resetTutorial(): Reset tutorial state to test first-time experience");async function ot(n=50){console.warn(`🎲 Generating ${n} random sequences for testing...`);try{const t=await openDB();let e=0;for(let i=0;i<n;i++){const o=Math.floor(Math.random()*8)+1,s=[],a=new Set;for(let c=0;c<o;c++){let r;do r=Math.floor(Math.random()*24);while(a.has(r));a.add(r),s.push(r)}s.sort((c,r)=>c-r),await t.transaction("sequences","readwrite").objectStore("sequences").add(s),e++,typeof addSequenceThumbnail=="function"&&addSequenceThumbnail(s),i%10===0&&await new Promise(c=>setTimeout(c,10))}console.log(`✅ Generated ${e} random sequences successfully`),console.log("📊 Sequences range from 1-8 circles each, randomly distributed across all 24 positions")}catch(t){console.error("❌ Error generating random sequences:",t)}}async function it(){console.warn("🎨 Generating test patterns for design testing...");const n=[[0],[3],[6],[9],[12],[15],[18],[21],[0,1,2],[3,4,5],[6,7,8],[9,10,11],[0,3,6,9,12,15,18,21],[1,4,7,10,13,16,19,22],[2,5,8,11,14,17,20,23],[0,6,12,18],[3,9,15,21],[0,1,3,4,6,7,9,10],[0,2,5,8,11,14,17,20],[1,4,7,10,13,16,19,22]];try{const t=await openDB();for(const e of n)await t.transaction("sequences","readwrite").objectStore("sequences").add(e),typeof addSequenceThumbnail=="function"&&addSequenceThumbnail(e);console.log(`✅ Generated ${n.length} test patterns`)}catch(t){console.error("❌ Error generating test patterns:",t)}}window.generateRandomSequences=ot;window.generateTestPatterns=it;console.log("🔧 Dev helpers available:");console.log("  - generateRandomSequences(50) - Generate random sequences");console.log("  - generateTestPatterns() - Generate specific test patterns");console.log("  - clearAllData() - Clear all data and reload");console.log("  - resetTutorial() - Reset tutorial state")});export default st();
