var Re=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var st=Re((ct,U)=>{(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();class we{constructor(){this.themes=["light","dark","system"],this.currentTheme="system",this.init()}async init(){await this.loadThemePreference(),this.applyTheme(this.currentTheme),this.setupEventListeners(),this.setupSystemThemeListener(),this.updateThemeButtons()}async loadThemePreference(){try{const t=await getPreferences();this.currentTheme=t.theme||"system"}catch{console.log("No stored theme preference, using system default"),this.currentTheme="system"}}async saveThemePreference(t){try{const e=await getPreferences();e.theme=t,await savePreferences(e)}catch(e){console.error("Failed to save theme preference:",e)}}setupEventListeners(){document.querySelectorAll("button[data-theme]").forEach(e=>{const o=e.dataset.theme;e.addEventListener("click",i=>{const s=i.currentTarget.dataset.theme;this.setTheme(s),window.innerWidth<640&&this.showMobileTooltip(e,s)}),e.addEventListener("mouseenter",i=>{window.innerWidth>=640&&this.showThemeTooltip(i.currentTarget,o)}),e.addEventListener("mouseleave",()=>{window.innerWidth>=640&&this.hideTooltip()})})}setupSystemThemeListener(){window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{this.currentTheme==="system"&&this.applySystemTheme()})}async setTheme(t){this.themes.includes(t)&&(this.currentTheme=t,await this.saveThemePreference(t),this.applyTheme(t),this.updateThemeButtons())}applyTheme(t){const e=document.documentElement;e.classList.remove("dark","light"),t==="dark"?e.classList.add("dark"):t==="light"?e.classList.add("light"):t==="system"&&this.applySystemTheme(),this.updateMetaThemeColor(t),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}applySystemTheme(){const t=document.documentElement,e=window.matchMedia("(prefers-color-scheme: dark)").matches;t.classList.remove("dark","light"),e?t.classList.add("dark"):t.classList.add("light"),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}updateMetaThemeColor(t){const e=document.querySelector('meta[name="theme-color"]'),o=document.querySelector('meta[name="msapplication-TileColor"]');let i;t==="dark"||t==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches?i="#232323":i="#1F1F1F",e&&e.setAttribute("content",i),o&&o.setAttribute("content",i)}updateThemeButtons(){document.querySelectorAll("button[data-theme]").forEach(e=>{if(e.classList.remove("bg-swarmshadow-200","text-swarmlight-100","ring-2","ring-swarmlight-300","bg-swarmlight-300","text-swarmshadow-200","ring-swarmshadow-200","bg-swarmlight-200","text-black","text-white","font-semibold"),e.classList.remove("active"),e.dataset.theme===this.currentTheme){const o=e.dataset.theme,i=document.documentElement.classList.contains("dark");o==="dark"?e.classList.add("bg-swarmshadow-200","text-swarmlight-100"):o==="light"?e.classList.add("bg-swarmlight-300","text-swarmshadow-200"):o==="system"&&(e.classList.add("ring-2","font-semibold"),i?(e.classList.add("text-white","ring-swarmlight-600","dark:hover:text-swarmlight-50"),e.classList.remove("dark:hover:text-black")):e.classList.add("text-black","ring-swarmlight-300"),i?e.style.background="linear-gradient(45deg, #706A43 50%, #232323 50%)":e.style.background="linear-gradient(45deg, #FFFDE7 50%, #FFEE58 50%)"),o!=="system"&&(e.classList.add("ring-2"),i?e.classList.add("ring-swarmlight-600"):e.classList.add("ring-swarmlight-300"))}else e.dataset.theme==="system"&&(e.classList.add("dark:hover:text-black"),e.classList.remove("dark:hover:text-swarmlight-50"),e.style.background="")})}getCurrentTheme(){return this.currentTheme}getEffectiveTheme(){return this.currentTheme==="system"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":this.currentTheme}getThemeDescription(t){switch(t){case"light":return"Light theme - bright interface";case"dark":return"Dark theme - dark interface";case"system":return"System theme - follows your device settings";default:return"Theme option"}}showThemeTooltip(t,e){const o=this.getThemeDescription(e);if(window.showTooltip){const s=t.closest(".theme-switcher")||t;window.showTooltip(o,s,0)}}showMobileTooltip(t,e){const o=this.getThemeDescription(e);if(window.showTooltip){const s=t.closest(".theme-switcher")||t;window.showTooltip(o,s,0),setTimeout(()=>{window.hideTooltip&&window.hideTooltip()},2e3)}}hideTooltip(){window.hideTooltip&&window.hideTooltip()}}document.addEventListener("DOMContentLoaded",()=>{window.themeManager=new we});typeof U<"u"&&U.exports&&(U.exports=we);const R=document.getElementById("tooltip");function ye(n,t,e=0){const o=t.getBoundingClientRect(),i=window.innerWidth,s=window.innerHeight;R.textContent=n;const a=t.closest("#sequenceModal")!==null;let c,l;if(a||i<640){const r=R.offsetWidth||200;if(a){const u=document.getElementById("modalContent").getBoundingClientRect();c=u.left+(u.width-r)/2,l=u.top-40,l<16&&(l=u.top+8)}else c=(i-r)/2,l=o.bottom+8;c=Math.max(8,Math.min(c,i-r-8)),l=Math.max(8,Math.min(l,s-50))}else{c=o.left+o.width/2-R.offsetWidth/2+e,l=o.bottom+16;const r=R.offsetWidth||200;c=Math.max(8,Math.min(c,i-r-8))}R.style.left=c+"px",R.style.top=l+"px",R.classList.remove("hidden"),R.removeAttribute("aria-hidden")}function pe(){R.classList.add("hidden"),R.setAttribute("aria-hidden","true")}window.showTooltip=ye;window.hideTooltip=pe;window.showTooltip=ye;window.hideTooltip=pe;async function Se(n){const t=document.getElementById("sequenceBar"),e=80,o=document.createElement("canvas");o.width=e*dpr,o.height=e*dpr,o.style.width=e+"px",o.style.height=e+"px";const i=o.getContext("2d");i.scale(dpr,dpr);let s,a,c;Array.isArray(n)?(s=n,a=!1,c=3):(s=n.sequence||n,a=n.isLoop||!1,c=n.loopInterval||3);const l=3,r=e-l,d=e/2,u=e/2,h=r*.08,f=h*.35,g=h*1.8;i.beginPath(),i.arc(d,u,h,0,2*Math.PI);const y=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";if(i.fillStyle=y,i.fill(),smallCircles.forEach(({dirX:S,dirY:v,audio:E},I)=>{for(let M=1;M<=3;M++){const K=[0,1,2,3,4,5,7,6].indexOf(I)*3+(M-1),be=s.includes(K),Z=d+S*g*M,ee=u+v*g*M;if(Z-f>=l&&Z+f<=e-l&&ee-f>=l&&ee+f<=e-l){i.beginPath(),i.arc(Z,ee,f,0,2*Math.PI);const de=window.themeManager?window.themeManager.getEffectiveTheme():"light",Ce=de==="dark"?"#fff":"#000",Ie=de==="dark"?"#000":"#fff";i.fillStyle=Ce,i.strokeStyle=Ie,i.lineWidth=.5,be?i.fill():i.stroke()}}}),o.sequenceData={seq:s,isLoop:a,loopInterval:c},window.audioSystem&&window.audioSystem.isSequenceLooping&&window.audioSystem.isSequenceLooping(s)){const S=document.documentElement.classList.contains("dark");o.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","p-2"),S?o.classList.add("bg-swarmshadow-50"):o.classList.add("bg-swarmstripe-200/50"),o.style.animation="loop-pulse 2s ease-in-out infinite"}t.appendChild(o)}function ne(){if(typeof loadAllSequences>"u"||typeof smallCircles>"u"||typeof dpr>"u"){setTimeout(ne,10);return}loadAllSequences().then(n=>{n.forEach(t=>Se(t)),console.log(`✅ Loaded ${n.length} saved sequences`)}).catch(n=>{console.error("Failed to load sequences:",n)})}function Ae(){document.getElementById("sequenceBar").querySelectorAll("canvas").forEach(e=>e.remove()),loadAllSequences().then(e=>{e.forEach(o=>Se(o))}).catch(e=>{console.error("Failed to reload sequences after theme change:",e)})}document.addEventListener("DOMContentLoaded",()=>{if(window.themeManager){const n=window.themeManager.setTheme.bind(window.themeManager);window.themeManager.setTheme=async function(t){await n(t),Ae()}}});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ne):ne();const ie={ZERO:0,ONE:.25,TWO:.5,THREE:.75},Be=.01;let te=null;function Te(){return te||(te=new(window.AudioContext||window.webkitAudioContext)),te}function Me(n){const t=Math.floor(n/3),e=n%3;return{radian:e+1,direction:t,position:e}}function De(n){const t=Math.floor(n/3);return typeof smallCircles<"u"&&smallCircles[t]?smallCircles[t].audio:null}function Pe(){if(typeof ripples<"u"&&typeof canvas<"u"){const n=canvas.clientWidth/2,t=canvas.clientHeight/2,i=Math.min(canvas.clientWidth,canvas.clientHeight)*.15*.4;ripples.push({x:n,y:t,radius:i,alpha:1})}}async function J(n,t={}){if(!n||n.length===0){console.warn("No sequence to play");return}const{inModal:e=!1}=t,o=Te();o.state==="suspended"&&await o.resume(),window.canvasHighlight&&window.canvasHighlight.clearAllHighlights(),e&&window.modalHighlight&&window.modalHighlight.clearModalHighlights();const i={0:[],1:[],2:[],3:[]};n.forEach(s=>{const{radian:a}=Me(s);i[a].push(s)}),Pe(),e&&window.modalHighlight&&window.modalHighlight.createModalRipple(),typeof dropletSound<"u"&&setTimeout(()=>{dropletSound.currentTime=0,dropletSound.play().catch(s=>console.warn("Failed to play droplet sound:",s)),window.canvasHighlight&&window.canvasHighlight.highlightCircle(-1,400),e&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(-1,400)},0),Object.keys(i).forEach(s=>{const a=i[s];if(a.length===0)return;const c=parseInt(s),l=ie[Object.keys(ie)[c]]*1e3;a.forEach((r,d)=>{const u=De(r);if(u){const h=l+d*Be*1e3;setTimeout(()=>{u.currentTime=0,u.play().catch(f=>console.warn(`Failed to play audio for circle ${r}:`,f)),window.canvasHighlight&&window.canvasHighlight.highlightCircle(r,600),e&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(r,600)},h)}})})}const j=5;let P=new Map;function ve(n){return JSON.stringify(n)}function le(n,t){const e=ve(n);if(P.has(e)){const o=P.get(e);clearInterval(o.timer),P.delete(e),console.log("🔄 Loop playback stopped for sequence:",e.substring(0,50)+"..."),oe(),N()}else{if(P.size>=j){console.warn(`🔄 Maximum number of concurrent loops (${j}) reached. Cannot start new loop.`);const i=document.getElementById("loopCounter");if(i){const s=i.className;i.className=i.className.replace(/bg-\S+/g,"bg-red-200 dark:bg-red-800"),i.style.animation="pulse 0.5s ease-in-out 2",setTimeout(()=>{i.className=s,i.style.animation=""},1e3)}return}console.log(`🔄 Starting loop playback every ${t}s`),J(n);const o=setInterval(async()=>{try{await J(n)}catch(i){console.error("Error in loop playback:",i),le(n,t)}},t*1e3);P.set(e,{timer:o,sequence:n,interval:t}),oe(),N()}}function Ee(n){if(!n)return!1;const t=ve(n);return P.has(t)}function N(){const n=document.getElementById("loopCounter");if(!n)return;const t=P.size;t>0?(n.textContent=`Loops playing: ${t}/${j}`,n.classList.remove("hidden")):n.classList.add("hidden")}function oe(){const n=document.getElementById("sequenceBar");if(!n)return;n.querySelectorAll("canvas").forEach(e=>{const o=e.sequenceData;if(o){const i=Ee(o.seq),s=document.documentElement.classList.contains("dark");e.classList.remove("bg-swarmstripe-200/50","bg-swarmshadow-50","rounded-lg","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),e.style.backgroundColor="",e.style.animation="",i&&(e.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),s?e.classList.add("bg-swarmshadow-50"):e.classList.add("bg-swarmstripe-200/50"),e.style.animation="loop-pulse 2s ease-in-out infinite")}})}function se(){if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",se);return}const n=document.getElementById("sequenceBar");if(!n){console.warn("Sequence bar not found, retrying..."),setTimeout(se,100);return}n.addEventListener("click",async t=>{const e=t.target.closest("canvas");if(!e)return;let o;if(e.sequenceData)o=e.sequenceData;else{const c=Array.from(n.children).indexOf(e);try{o=(await loadAllSequences())[c]}catch(l){console.error("Error loading sequence:",l);return}}if(!o)return;let i,s,a;Array.isArray(o)?(i=o,s=!1,a=3):(i=o.seq||o.sequence,s=o.isLoop||!1,a=o.loopInterval||3);try{s?le(i,a):await J(i)}catch(c){console.error("Error playing sequence:",c)}})}se();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N();window.audioSystem={playSequence:J,initAudioContext:Te,toggleLoopPlayback:le,isSequenceLooping:Ee,updateThumbnailLoopStates:oe,updateLoopCounter:N,getRadianInfo:Me,RADIAN_TIMING:ie,MAX_CONCURRENT_LOOPS:j,getActiveLoopCount:()=>P.size};class Le{constructor(){this.contextMenu=null,this.currentThumbnail=null,this.init()}init(){this.contextMenu=document.getElementById("contextMenu"),this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",e=>{this.contextMenu.contains(e.target)||this.hideContextMenu()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.hideContextMenu()}),document.getElementById("editSequence").addEventListener("click",()=>{this.editSequence(),this.hideContextMenu()}),document.getElementById("deleteSequence").addEventListener("click",()=>{this.deleteSequence(),this.hideContextMenu()});const t=document.getElementById("sequenceBar");t&&t.addEventListener("contextmenu",e=>{const o=e.target.closest("canvas");o&&o.sequenceData&&(e.preventDefault(),this.showContextMenu(e,o))})}showContextMenu(t,e){this.currentThumbnail=e,this.contextMenu.style.visibility="hidden",this.contextMenu.classList.remove("hidden");const o=this.contextMenu.getBoundingClientRect(),i=o.width,s=o.height,a=window.innerWidth,c=window.innerHeight;let l=t.clientX,r=t.clientY;const d=8;l+i+d>a&&(l=l-i,l<d&&(l=a-i-d)),l=Math.max(d,l),r+s+d>c&&(r=r-s,r<d&&(r=c-s-d)),r=Math.max(d,r);const u=document.getElementById("sequenceBar");if(u){const h=u.getBoundingClientRect();t.clientY>=h.top&&r+s>h.top&&(r=Math.max(d,h.top-s-4))}this.contextMenu.style.left=l+"px",this.contextMenu.style.top=r+"px",this.contextMenu.style.visibility="visible"}hideContextMenu(){this.contextMenu.classList.add("hidden"),this.contextMenu.style.visibility="",this.currentThumbnail=null}editSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const t=this.currentThumbnail.sequenceData;this.currentThumbnail.setAttribute("data-editing","true"),window.modalManager&&window.modalManager.openEditMode(t,this.currentThumbnail)}async deleteSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const t=this.currentThumbnail,e=this.currentThumbnail.sequenceData;if(confirm("Are you sure you want to delete this sequence? This action cannot be undone."))try{const s=(await loadAllSequences()).findIndex(a=>{const c=Array.isArray(a)?a:a.sequence||a.seq,l=Array.isArray(e)?e:e.sequence||e.seq;return JSON.stringify(c)===JSON.stringify(l)});if(s!==-1){if(await deleteSequence(s),t.remove(),window.audioSystem&&window.audioSystem.isSequenceLooping){const a=Array.isArray(e)?e:e.sequence||e.seq;if(window.audioSystem.isSequenceLooping(a)){const c=e.loopInterval||3;window.audioSystem.toggleLoopPlayback(a,c)}}console.log("✅ Sequence deleted successfully")}else console.error("❌ Sequence not found in storage"),alert("Sequence not found in storage. It may have already been deleted.")}catch(i){console.error("❌ Failed to delete sequence:",i),alert("Failed to delete sequence. Please try again.")}}}document.addEventListener("DOMContentLoaded",()=>{window.contextMenuManager=new Le});window.ContextMenuManager=Le;const L=document.getElementById("soundCanvas"),w=L.getContext("2d"),Y=window.devicePixelRatio||1;let D=new Map;const he=new Audio("./assets/5.mp3"),Qe=[{dirX:0,dirY:-1,audio:new Audio("./assets/2.mp3")},{dirX:0,dirY:1,audio:new Audio("./assets/8.mp3")},{dirX:-1,dirY:0,audio:new Audio("./assets/4.mp3")},{dirX:1,dirY:0,audio:new Audio("./assets/6.mp3")},{dirX:1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/3.mp3")},{dirX:-1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/1.mp3")},{dirX:-1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/7.mp3")},{dirX:1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/9.mp3")}];function He(){const n=L.clientWidth,t=L.clientHeight;L.width=n*Y,L.height=t*Y,w.resetTransform(),w.scale(Y,Y)}function Oe(){He();const n=L.clientWidth,t=L.clientHeight,e=n/2,o=t/2,i=Math.min(n,t),s=.4,a=i*.15*s,c=a*.4,l=a+c+i*.12*s;if(w.clearRect(0,0,n,t),w.beginPath(),w.arc(e,o,a,0,Math.PI*2),w.lineWidth=c,D.has(-1)){const{startTime:d,duration:u}=D.get(-1),h=ue(d,u);if(h>0){const f=Math.floor(255*h),g=Math.floor(107*h),p=Math.floor(107*h);w.strokeStyle=`rgb(${f}, ${g}, ${p})`}else{const f=window.themeManager?window.themeManager.getEffectiveTheme():"light";w.strokeStyle=f==="dark"?"#fff":"#000",D.delete(-1)}}else{const d=window.themeManager?window.themeManager.getEffectiveTheme():"light";w.strokeStyle=d==="dark"?"#fff":"#000"}w.stroke(),[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((d,u)=>{for(let h=1;h<=3;h++){const f=e+d.x*l*h,g=o+d.y*l*h,p=u*3+(h-1);if(w.beginPath(),w.arc(f,g,c,0,Math.PI*2),D.has(p)){const{startTime:y,duration:S}=D.get(p),v=ue(y,S);if(v>0){const E=Math.floor(255*v),I=Math.floor(107*v),M=Math.floor(107*v);w.fillStyle=`rgb(${E}, ${I}, ${M})`,w.fill(),w.strokeStyle="#fff",w.lineWidth=2,w.stroke()}else{D.delete(p);const E=window.themeManager?window.themeManager.getEffectiveTheme():"light";w.fillStyle=E==="dark"?"#fff":"#000",w.fill()}}else{const y=window.themeManager?window.themeManager.getEffectiveTheme():"light";w.fillStyle=y==="dark"?"#fff":"#000",w.fill()}}})}const ae=[],$e=.006,We=.016;L.addEventListener("click",n=>{const t=L.getBoundingClientRect(),e=L.clientWidth,o=L.clientHeight,i=n.clientX-t.left,s=n.clientY-t.top,a=e/2,c=o/2,l=Math.min(e,o),r=.4,d=l*.15*r;if((i-a)**2+(s-c)**2<=d*d){ae.push({x:a,y:c,radius:d,alpha:1}),he.currentTime=0,he.play();return}const u=d*.4,h=d+u+l*.12*r;for(const{dirX:f,dirY:g,audio:p}of Qe)for(let y=1;y<=3;y++){const S=a+f*h*y,v=c+g*h*y;if((i-S)**2+(s-v)**2<=u*u){p.currentTime=0,p.play();return}}});function Ne(){const t=Math.min(L.clientWidth,L.clientHeight)*$e,o=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"255,255,255":"0,0,0";ae.forEach((i,s)=>{w.beginPath(),w.arc(i.x,i.y,i.radius,0,Math.PI*2),w.strokeStyle=`rgba(${o},${i.alpha})`,w.lineWidth=2,w.stroke(),i.radius+=t,i.alpha-=We,i.alpha<=0&&ae.splice(s,1)})}function xe(){Oe(),Ne(),requestAnimationFrame(xe)}function Fe(n,t=500){const e=Date.now();D.set(n,{startTime:e,duration:t})}function Xe(){D.clear()}window.canvasHighlight={highlightCircle:Fe,clearAllHighlights:Xe};function ue(n,t){const e=Date.now()-n,o=Math.min(e/t,1),i=4,s=Math.max(0,1-o),a=Math.sin(e*i/100)*.3+.7;return s*a}xe();const G=document.getElementById("createSequenceBtn"),A=document.getElementById("sequenceModal"),x=document.getElementById("sequenceCanvas"),m=x.getContext("2d"),me=document.getElementById("modalTitle");let B=new Map,F=[];const _e=4,Ye=.04;class ze{constructor(){this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,this.init()}init(){this.setupEventListeners()}setupEventListeners(){G.addEventListener("click",()=>{this.openCreateMode()})}async openCreateMode(){hideTooltip(),G.classList.remove("highlight-once"),document.body.classList.remove("tutorial-active"),this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,me.textContent="Create New Sequence",q=!await getSetting("tutorialSeen"),q?(z.classList.remove("hidden"),Je.textContent=W,ke.textContent="0"):z.classList.add("hidden"),this.resetModalState(),this.showModal()}openEditMode(t,e){this.isEditMode=!0,this.editingThumbnail=e,this.originalSequenceData=JSON.parse(JSON.stringify(t)),me.textContent="Edit Sequence",q=!1,z.classList.add("hidden"),this.resetModalState(),this.showModal(),this.loadSequenceIntoModal(t),_(),ce()}resetModalState(){k.forEach(e=>{e.clicked=!1}),O.checked=!1,Q.value=3,X.style.opacity="0.5",Q.disabled=!0,B.clear(),F.length=0;const t=document.getElementById("modalInstruction");t&&t.classList.add("hidden")}loadSequenceIntoModal(t){const e=Array.isArray(t)?t:t.seq||t.sequence||[],o=t.isLoop||!1,i=t.loopInterval||3;O.checked=o,Q.value=i,o&&(X.style.opacity="1",Q.disabled=!1),e.forEach(s=>{k[s]&&(k[s].clicked=!0)})}showModal(){A.classList.remove("hidden"),A.classList.add("flex"),A.setAttribute("aria-hidden","false"),this.initializeModalCircles(),_(),re(),q&&qe(),ce()}initializeModalCircles(){const t=x.clientWidth,e=x.clientHeight,o=250,i=(t-o)/2,s=(e-o)/2,a=o/2,c=o/2,l=o*.09,r=l*.3,d=l+r*2,u=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}];k=[],u.forEach((h,f)=>{const g=[0,1,2,3,4,5,7,6],p=smallCircles[g[f]].audio;for(let y=1;y<=3;y++)k.push({x:i+a+h.x*d*y,y:s+c+h.y*d*y,r,audio:p,clicked:!1})})}}function Ue(){const n=x.clientWidth,t=x.clientHeight;x.width=n*dpr,x.height=t*dpr,m.resetTransform(),m.scale(dpr,dpr)}const C=document.getElementById("testSequenceBtn"),H=document.getElementById("saveSequenceBtn"),z=document.getElementById("tutorialCounter"),Je=document.getElementById("targetCount"),ke=document.getElementById("selectedCount"),O=document.getElementById("loopToggle"),Q=document.getElementById("loopInterval"),X=document.getElementById("loopIntervalControls");let k=[],q=!1;const W=5;async function je(){try{const n=await getSetting("tutorialSeen"),t=await loadAllSequences();!n&&t.length===0&&(document.body.classList.add("tutorial-active"),G.classList.add("highlight-once"),showTooltip("Start playing by clicking New Sequence!",G))}catch(n){console.log("Could not check tutorial state:",n)}}setTimeout(je,100);const T=new ze;window.modalManager=T;function _(){Ue();const n=x.clientWidth,t=x.clientHeight,e=Math.min(250,250);m.clearRect(0,0,n,t),m.save();const o=(n-e)/2,i=(t-e)/2;m.translate(o,i);const s=e/2,a=e/2;Ge();const c=e*.09;if(m.beginPath(),m.arc(s,a,c,0,2*Math.PI),B.has(-1)){const{startTime:u,duration:h}=B.get(-1),f=fe(u,h);if(f>0){const g=Math.floor(255*f),p=Math.floor(107*f),y=Math.floor(107*f);m.fillStyle=`rgb(${g}, ${p}, ${y})`}else{const g=window.themeManager?window.themeManager.getEffectiveTheme():"light";m.fillStyle=g==="dark"?"#fff":"#000",B.delete(-1)}}else{const u=window.themeManager?window.themeManager.getEffectiveTheme():"light";m.fillStyle=u==="dark"?"#fff":"#000"}m.fill();const l=c*.3,r=c+l*2;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((u,h)=>{var f;for(let g=1;g<=3;g++){const p=s+u.x*r*g,y=a+u.y*r*g,S=h*3+(g-1);m.beginPath(),m.arc(p,y,l,0,2*Math.PI);const v=(f=k[S])==null?void 0:f.clicked;if(B.has(S)){const{startTime:E,duration:I}=B.get(S),M=fe(E,I);if(M>0){const $=Math.floor(255*M),b=Math.floor(107*M),K=Math.floor(107*M);m.fillStyle=`rgb(${$}, ${b}, ${K})`,m.fill(),m.strokeStyle="#fff",m.lineWidth=2,m.stroke()}else{B.delete(S);const b=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";v?(m.fillStyle=b,m.fill()):(m.strokeStyle=b,m.lineWidth=2,m.stroke())}}else{const I=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";v?(m.fillStyle=I,m.fill()):(m.strokeStyle=I,m.lineWidth=2,m.stroke())}}}),m.restore()}function Ge(n,t,e,o){const s=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"255,255,255":"0,0,0";F.forEach((a,c)=>{m.beginPath(),m.arc(a.x,a.y,a.radius,0,Math.PI*2),m.strokeStyle=`rgba(${s},${a.alpha})`,m.lineWidth=2,m.stroke(),a.radius+=_e,a.alpha-=Ye,a.alpha<=0&&F.splice(c,1)})}function Ve(n,t=600){const e=Date.now();B.set(n,{startTime:e,duration:t})}function Ke(){B.clear()}function Ze(){F.push({x:125,y:125,radius:22.5,alpha:1})}function re(){A.classList.contains("hidden")||(_(),requestAnimationFrame(re))}window.modalHighlight={highlightModalCircle:Ve,clearModalHighlights:Ke,createModalRipple:Ze,startAnimation:re};x.addEventListener("click",async n=>{const t=x.getBoundingClientRect(),e=n.clientX-t.left,o=n.clientY-t.top,i=x.clientWidth,s=x.clientHeight,a=250,c=(i-a)/2,l=(s-a)/2,r=e-c,d=o-l,u=a/2,h=a/2,f=a*.09,g=f*.3,p=f+g*2;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((S,v)=>{for(let E=1;E<=3;E++){const I=u+S.x*p*E,M=h+S.y*p*E,$=v*3+(E-1),b=k[$];if(b&&!b.clicked&&(r-I)**2+(d-M)**2<=g*g){b.clicked=!0,b.audio.currentTime=0,b.audio.play(),ce(),_();return}}})});function ce(){const n=k.filter(t=>t.clicked).length;q?(n===W?(C.disabled=!1,C.classList.add("highlight-once"),showTooltip("Click Test to hear what your sequence sounds like!",C)):(C.disabled=!0,C.classList.remove("highlight-once")),qe()):n>0?(C.disabled=!1,H.disabled=!1):(C.disabled=!0,H.disabled=!0)}function qe(){if(!q)return;const n=k.filter(e=>e.clicked).length;ke.textContent=n;const t=document.getElementById("modalInstruction");if(n===0)t.textContent="Click the empty circles to form your sequence",t.classList.remove("hidden"),hideTooltip();else if(n<W){const e=W-n;t.textContent=`Select ${e} more circle${e===1?"":"s"}`,t.classList.remove("hidden"),hideTooltip()}else n===W&&(t.classList.add("hidden"),hideTooltip())}C.addEventListener("click",async n=>{hideTooltip(),C.classList.remove("highlight-once");const t=k.map((e,o)=>e.clicked?o:null).filter(e=>e!==null);if(t.length>0)try{window.audioSystem&&window.audioSystem.playSequence?await window.audioSystem.playSequence(t,{inModal:!0}):console.warn("Audio system not available, falling back to basic feedback"),q&&(H.disabled=!1),q&&(await setSetting("tutorialSeen",!0),q=!1)}catch(e){console.error("Error playing test sequence:",e),q&&(H.disabled=!1)}});O.addEventListener("change",()=>{const n=O.checked;Q.disabled=!n,n?X.classList.remove("opacity-50"):X.classList.add("opacity-50")});H.addEventListener("click",async()=>{const n=k.map((i,s)=>i.clicked?s:null).filter(i=>i!==null),t=O.checked,e=parseInt(Q.value)||3,o={sequence:n,isLoop:t,loopInterval:e};try{if(T.isEditMode){const i=await loadAllSequences(),s=Array.isArray(T.originalSequenceData)?T.originalSequenceData:T.originalSequenceData.sequence||T.originalSequenceData.seq,a=i.findIndex(c=>{const l=Array.isArray(c)?c:c.sequence||c.seq;return JSON.stringify(l)===JSON.stringify(s)});if(a!==-1){if(await updateSequence(a,o),window.audioSystem&&window.audioSystem.isSequenceLooping&&window.audioSystem.isSequenceLooping(s)){const c=T.originalSequenceData.loopInterval||3;window.audioSystem.toggleLoopPlayback(s,c)}T.editingThumbnail.removeAttribute("data-editing"),T.editingThumbnail.remove(),addSequenceThumbnail(o),console.log("✅ Sequence updated successfully")}else throw new Error("Original sequence not found in storage")}else await saveSequenceToDB(o),addSequenceThumbnail(o),console.log("✅ New sequence saved successfully");q&&await setSetting("tutorialSeen",!0),V()}catch(i){console.error("❌ Failed to save sequence:",i),alert("Failed to save sequence. Please try again.")}});function V(){hideTooltip(),A.classList.add("hidden"),A.classList.remove("flex"),A.setAttribute("aria-hidden","true"),T.isEditMode&&T.editingThumbnail&&T.editingThumbnail.removeAttribute("data-editing"),T.isEditMode=!1,T.editingThumbnail=null,T.originalSequenceData=null,k.forEach(t=>t.clicked=!1),C.disabled=!0,C.classList.remove("highlight-once"),H.disabled=!0,z.classList.add("hidden"),q=!1;const n=document.getElementById("modalInstruction");n&&n.classList.add("hidden"),O.checked=!1,Q.value=3,Q.disabled=!0,X.style.opacity="0.5",window.modalHighlight&&window.modalHighlight.clearModalHighlights(),F.length=0,_()}const et=document.getElementById("closeModalBtn");et.addEventListener("click",V);A.addEventListener("click",n=>{n.target===A&&V()});const tt=document.getElementById("modalContent");tt.addEventListener("click",n=>{n.stopPropagation()});document.addEventListener("keydown",n=>{n.key==="Escape"&&!A.classList.contains("hidden")&&V()});function fe(n,t){const e=Date.now()-n,o=Math.min(e/t,1),i=4,s=Math.max(0,1-o),a=Math.sin(e*i/100)*.3+.7;return s*a}const nt="modulepreload",it=function(n){return"/"+n},ge={},ot=function(t,e,o){let i=Promise.resolve();if(e&&e.length>0){let a=function(r){return Promise.all(r.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));i=a(e.map(r=>{if(r=it(r),r in ge)return;ge[r]=!0;const d=r.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${u}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":nt,d||(h.as="script"),h.crossOrigin="",h.href=r,l&&h.setAttribute("nonce",l),document.head.appendChild(h),d)return new Promise((f,g)=>{h.addEventListener("load",f),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${r}`)))})}))}function s(a){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=a,window.dispatchEvent(c),!c.defaultPrevented)throw a}return i.then(a=>{for(const c of a||[])c.status==="rejected"&&s(c.reason);return t().catch(s)})};(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.protocol==="file:")&&ot(()=>import("./dev-tools-Dq8GD3tT.js"),[]).catch(n=>{console.log("Dev tools not loaded (production build)")})});export default st();
