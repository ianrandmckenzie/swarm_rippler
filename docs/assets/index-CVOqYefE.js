!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();function e(){return new Promise((e,t)=>{const n=indexedDB.open("clickRippleDB",1);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("settings")||t.createObjectStore("settings"),t.objectStoreNames.contains("sequences")||t.createObjectStore("sequences",{autoIncrement:!0})},n.onsuccess=t=>e(t.target.result),n.onerror=e=>t(e.target.error)})}async function t(t){const n=await e();return new Promise(e=>{const i=n.transaction("settings","readonly").objectStore("settings").get(t);i.onsuccess=()=>e(i.result),i.onerror=()=>e(null)})}async function n(t,n){(await e()).transaction("settings","readwrite").objectStore("settings").put(n,t)}async function i(){const t=await e();return new Promise(e=>{const n=t.transaction("sequences","readonly").objectStore("sequences").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>e([])})}async function s(){return await t("preferences")||{theme:"system",volume:.7,showTutorial:!0}}class o{static bounce(e,t=1.05,n=150){e&&(e.style.transition=`transform ${n}ms cubic-bezier(0.68, -0.55, 0.265, 1.55)`,e.style.transform=`scale(${t})`,setTimeout(()=>{e.style.transform="scale(1)",setTimeout(()=>{e.style.transition="",e.style.transform=""},n)},n))}static press(e,t=.95,n=100){e&&(e.style.transition=`transform ${n}ms ease-out`,e.style.transform=`scale(${t})`,setTimeout(()=>{e.style.transform="scale(1)",setTimeout(()=>{e.style.transition="",e.style.transform=""},n)},n))}static pulse(e,t=null,n=300){if(!e)return;if(!t){t=document.documentElement.classList.contains("dark")?"rgba(255, 241, 118, 0.6)":"rgba(255, 235, 59, 0.6)"}const i=e.style.boxShadow;e.style.transition=`box-shadow ${n}ms ease-out`,e.style.boxShadow=`0 0 20px 4px ${t}`,setTimeout(()=>{e.style.boxShadow=i,setTimeout(()=>{e.style.transition=""},n)},n)}static canvasRipple(e,t,n,i=null){if(!e)return;if(!i){i="dark"===(window.themeManager?window.themeManager.getEffectiveTheme():"light")?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.8)"}const s=document.createElement("div");if(s.style.position="absolute",s.style.left=t-10+"px",s.style.top=n-10+"px",s.style.width="20px",s.style.height="20px",s.style.borderRadius="50%",s.style.background=i,s.style.pointerEvents="none",s.style.animation="feedback-ripple 0.6s ease-out forwards",s.style.zIndex="1000",!document.getElementById("feedback-styles")){const e=document.createElement("style");e.id="feedback-styles",e.textContent="\n        @keyframes feedback-ripple {\n          0% {\n            transform: scale(0);\n            opacity: 1;\n          }\n          100% {\n            transform: scale(4);\n            opacity: 0;\n          }\n        }\n      ",document.head.appendChild(e)}const o=e.closest('[id*="container"]')||e.parentElement;o&&(o.style.position="relative",o.appendChild(s),setTimeout(()=>{s.parentElement&&s.parentElement.removeChild(s)},600))}}const a=new class{constructor(){this.isSupported=this.checkSupport()}checkSupport(){var e;return!!(navigator.vibrate||window.DeviceMotionEvent||window.TapticEngine||(null==(e=window.__TAURI__)?void 0:e.invoke))}trigger(e="light",t=.5){var n;if(!this.isSupported)return;const i={light:[10],medium:[20],heavy:[40],radian:[15,10,15],select:[8],success:[25,15,25]},s=i[e]||i.light;try{navigator.vibrate?navigator.vibrate(s):window.TapticEngine?window.TapticEngine.impact({style:e}):(null==(n=window.__TAURI__)?void 0:n.invoke)&&window.__TAURI__.invoke("haptic_feedback",{type:e,intensity:t})}catch(o){}}radianFeedback(e){const t=e%3;this.trigger("radian",[.3,.5,.7][t])}};window.feedbackSystem={haptic:a,visual:o};class l{constructor(){this.themes=["light","dark","system"],this.currentTheme="system",this.init()}async init(){await this.loadThemePreference(),this.applyTheme(this.currentTheme),this.setupEventListeners(),this.setupSystemThemeListener(),this.updateThemeButtons(),await new Promise(e=>setTimeout(e,50)),this.initialized=!0,window.dispatchEvent(new CustomEvent("themeManagerReady"))}async loadThemePreference(){try{const e=await s();this.currentTheme=e.theme||"system"}catch(e){this.currentTheme="system"}}async saveThemePreference(e){try{const t=await s();t.theme=e,await async function(e){await n("preferences",e)}(t)}catch(t){}}setupEventListeners(){document.querySelectorAll("button[data-theme]").forEach(e=>{const t=e.dataset.theme;e.addEventListener("click",t=>{const n=t.currentTarget.dataset.theme;o.bounce(e,1.08,150),a.trigger("light"),this.setTheme(n),window.innerWidth<640&&this.showMobileTooltip(e,n)}),e.addEventListener("mouseenter",e=>{window.innerWidth>=640&&this.showThemeTooltip(e.currentTarget,t)}),e.addEventListener("mouseleave",()=>{window.innerWidth>=640&&this.hideTooltip()})})}setupSystemThemeListener(){window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{"system"===this.currentTheme&&this.applySystemTheme()})}async setTheme(e){this.themes.includes(e)&&(this.currentTheme=e,await this.saveThemePreference(e),this.applyTheme(e),this.updateThemeButtons())}applyTheme(e){const t=document.documentElement;t.classList.remove("dark","light"),"dark"===e?t.classList.add("dark"):"light"===e?t.classList.add("light"):"system"===e&&this.applySystemTheme(),this.updateMetaThemeColor(e),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}applySystemTheme(){const e=document.documentElement,t=window.matchMedia("(prefers-color-scheme: dark)").matches;e.classList.remove("dark","light"),t?e.classList.add("dark"):e.classList.add("light"),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}updateMetaThemeColor(e){const t=document.querySelector('meta[name="theme-color"]'),n=document.querySelector('meta[name="msapplication-TileColor"]');let i;i="dark"===e||"system"===e&&window.matchMedia("(prefers-color-scheme: dark)").matches?"#232323":"#1F1F1F",t&&t.setAttribute("content",i),n&&n.setAttribute("content",i)}updateThemeButtons(){document.querySelectorAll("button[data-theme]").forEach(e=>{if(e.classList.remove("bg-swarmshadow-200","text-swarmlight-100","ring-2","ring-swarmlight-300","bg-swarmlight-300","text-swarmshadow-200","ring-swarmshadow-200","bg-swarmlight-200","text-black","text-white","font-semibold"),e.classList.remove("active"),e.dataset.theme===this.currentTheme){const t=e.dataset.theme,n=document.documentElement.classList.contains("dark");"dark"===t?e.classList.add("bg-swarmshadow-200","text-swarmlight-100"):"light"===t?e.classList.add("bg-swarmlight-300","text-swarmshadow-200"):"system"===t&&(e.classList.add("ring-2","font-semibold"),n?(e.classList.add("text-white","ring-swarmlight-600","dark:hover:text-swarmlight-50"),e.classList.remove("dark:hover:text-black")):e.classList.add("text-black","ring-swarmlight-300"),e.style.background=n?"linear-gradient(45deg, #706A43 50%, #232323 50%)":"linear-gradient(45deg, #FFFDE7 50%, #FFEE58 50%)"),"system"!==t&&(e.classList.add("ring-2"),n?e.classList.add("ring-swarmlight-600"):e.classList.add("ring-swarmlight-300"))}else"system"===e.dataset.theme&&(e.classList.add("dark:hover:text-black"),e.classList.remove("dark:hover:text-swarmlight-50"),e.style.background="")})}getCurrentTheme(){return this.currentTheme}getEffectiveTheme(){return"system"===this.currentTheme?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":this.currentTheme}getThemeDescription(e){switch(e){case"light":return"Light theme - bright interface";case"dark":return"Dark theme - dark interface";case"system":return"System theme - follows your device settings";default:return"Theme option"}}showThemeTooltip(e,t){const n=this.getThemeDescription(t);if(window.showTooltip){const t=e.closest(".theme-switcher")||e;window.showTooltip(n,t,0)}}showMobileTooltip(e,t){const n=this.getThemeDescription(t);if(window.showTooltip){const t=e.closest(".theme-switcher")||e;window.showTooltip(n,t,0),setTimeout(()=>{window.hideTooltip&&window.hideTooltip()},2e3)}}hideTooltip(){window.hideTooltip&&window.hideTooltip()}}document.addEventListener("DOMContentLoaded",()=>{window.themeManager=new l});const r=new class{constructor(){this.tutorialMode=!1,this.isActive=!1,this.currentStep=0,this.elements=this.initializeElements(),this.setupWelcomeModal(),setTimeout(()=>this.checkAndShowTutorial(),100)}initializeElements(){return{createBtn:document.getElementById("createSequenceBtn"),tutorialCounter:document.getElementById("tutorialCounter"),targetCountEl:document.getElementById("targetCount"),selectedCountEl:document.getElementById("selectedCount"),modalInstruction:document.getElementById("modalInstruction"),testBtn:document.getElementById("testSequenceBtn"),saveBtn:document.getElementById("saveSequenceBtn"),tutorialOverlay:document.getElementById("tutorialOverlay"),welcomeModal:document.getElementById("tutorialWelcomeModal"),beginBtn:document.getElementById("beginTutorialBtn"),beginBtnMobile:document.getElementById("beginTutorialBtnMobile"),welcomeSteps:document.getElementById("welcomeSteps"),welcomeStepsContainer:document.getElementById("welcomeStepsContainer"),dots:[document.getElementById("dot0"),document.getElementById("dot1"),document.getElementById("dot2")]}}setupWelcomeModal(){this.elements.beginBtn&&this.elements.beginBtn.addEventListener("click",()=>{this.handleBeginClick(this.elements.beginBtn)}),this.elements.beginBtnMobile&&this.elements.beginBtnMobile.addEventListener("click",()=>{this.handleBeginClick(this.elements.beginBtnMobile)}),this.setupMobileSwipe(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isWelcomeModalOpen()&&(this.closeWelcomeModal(),this.startMainTutorial())})}handleBeginClick(e){o.press(e,.95,150),a.trigger("medium"),this.closeWelcomeModal(),this.startMainTutorial()}setupMobileSwipe(){if(!this.elements.welcomeStepsContainer)return;let e=0,t=0,n=!1;const i=i=>{e=i.touches?i.touches[0].clientX:i.clientX,t=i.touches?i.touches[0].clientY:i.clientY,n=!0},s=e=>{n&&e.preventDefault()},o=i=>{if(!n)return;n=!1;const s=i.changedTouches?i.changedTouches[0].clientX:i.clientX,o=i.changedTouches?i.changedTouches[0].clientY:i.clientY,a=e-s,l=Math.abs(t-o);Math.abs(a)>50&&l<100&&(a>0?this.nextStep():this.previousStep())};this.elements.welcomeStepsContainer.addEventListener("touchstart",i,{passive:!1}),this.elements.welcomeStepsContainer.addEventListener("touchmove",s,{passive:!1}),this.elements.welcomeStepsContainer.addEventListener("touchend",o,{passive:!1}),this.elements.welcomeStepsContainer.addEventListener("mousedown",i),this.elements.welcomeStepsContainer.addEventListener("mousemove",s),this.elements.welcomeStepsContainer.addEventListener("mouseup",o)}nextStep(){this.currentStep<2&&(this.currentStep++,this.updateStepDisplay())}previousStep(){this.currentStep>0&&(this.currentStep--,this.updateStepDisplay())}updateStepDisplay(){if(this.elements.welcomeSteps){const e=100*-this.currentStep;this.elements.welcomeSteps.style.transform=`translateX(${e}%)`}this.elements.dots.forEach((e,t)=>{e&&(t===this.currentStep?(e.classList.remove("opacity-50"),e.classList.add("opacity-100")):(e.classList.remove("opacity-100"),e.classList.add("opacity-50")))})}async checkAndShowTutorial(){try{const e=await t("tutorialSeen"),n=await i();e||0!==n.length||this.showWelcomeModal()}catch(e){}}showWelcomeModal(){this.elements.welcomeModal&&(this.elements.welcomeModal.classList.remove("hidden"),this.elements.welcomeModal.classList.add("flex"),this.elements.welcomeModal.setAttribute("aria-hidden","false"),this.currentStep=0,this.updateStepDisplay(),setTimeout(()=>{const e=window.innerWidth<640?this.elements.beginBtnMobile:this.elements.beginBtn;e&&2===this.currentStep&&e.focus()},100))}closeWelcomeModal(){this.elements.welcomeModal&&(this.elements.welcomeModal.classList.add("hidden"),this.elements.welcomeModal.classList.remove("flex"),this.elements.welcomeModal.setAttribute("aria-hidden","true"),this.currentStep=0,this.updateStepDisplay())}isWelcomeModalOpen(){return this.elements.welcomeModal&&!this.elements.welcomeModal.classList.contains("hidden")}startMainTutorial(){this.isActive=!0,document.body.classList.add("tutorial-active"),this.elements.createBtn.classList.add("highlight-once"),window.showTooltip&&window.showTooltip("Start playing by clicking New Sequence!",this.elements.createBtn)}startTutorial(){this.showWelcomeModal()}enableTutorialMode(){this.tutorialMode=!0,this.elements.tutorialCounter&&(this.elements.tutorialCounter.classList.remove("hidden"),this.elements.targetCountEl.textContent=5,this.elements.selectedCountEl.textContent="0")}disableTutorialMode(){this.tutorialMode=!1,this.elements.tutorialCounter&&this.elements.tutorialCounter.classList.add("hidden")}updateTutorialUI(e){if(this.tutorialMode&&(this.elements.selectedCountEl&&(this.elements.selectedCountEl.textContent=e),this.elements.modalInstruction))if(0===e)this.elements.modalInstruction.textContent="Click the empty circles to form your sequence",this.elements.modalInstruction.classList.remove("hidden"),this.hideTooltip();else if(e<5){const t=5-e;this.elements.modalInstruction.textContent=`Select ${t} more circle${1===t?"":"s"}`,this.elements.modalInstruction.classList.remove("hidden"),this.hideTooltip()}else 5===e&&(this.elements.modalInstruction.classList.add("hidden"),this.hideTooltip())}updateButtonStates(e){return!!this.tutorialMode&&(5===e?this.elements.testBtn&&(this.elements.testBtn.disabled=!1,this.elements.testBtn.classList.add("highlight-once"),window.showTooltip&&window.showTooltip("Click Test to hear what your sequence sounds like!",this.elements.testBtn)):this.elements.testBtn&&(this.elements.testBtn.disabled=!0,this.elements.testBtn.classList.remove("highlight-once"),this.hideTooltip()),this.updateTutorialUI(e),!0)}async handleTestClick(){return!!this.tutorialMode&&(this.hideTooltip(),this.elements.testBtn&&this.elements.testBtn.classList.remove("highlight-once"),this.elements.saveBtn&&(this.elements.saveBtn.disabled=!1),await this.completeTutorial(),!0)}async handleSaveClick(){return!!this.tutorialMode&&(await this.completeTutorial(),!0)}async completeTutorial(){try{await n("tutorialSeen",!0),this.tutorialMode=!1,this.isActive=!1,document.body.classList.remove("tutorial-active"),this.elements.createBtn&&this.elements.createBtn.classList.remove("highlight-once"),this.closeWelcomeModal()}catch(e){}}async resetTutorial(){try{return await n("tutorialSeen",!1),this.tutorialMode=!1,this.isActive=!1,document.body.classList.remove("tutorial-active"),this.elements.createBtn&&this.elements.createBtn.classList.remove("highlight-once"),this.elements.tutorialCounter&&this.elements.tutorialCounter.classList.add("hidden"),this.elements.modalInstruction&&this.elements.modalInstruction.classList.add("hidden"),this.closeWelcomeModal(),!0}catch(e){return!1}}cleanupTutorialState(){this.tutorialMode=!1,this.elements.tutorialCounter&&this.elements.tutorialCounter.classList.add("hidden"),this.elements.modalInstruction&&this.elements.modalInstruction.classList.add("hidden"),this.elements.testBtn&&this.elements.testBtn.classList.remove("highlight-once"),this.hideTooltip()}hideTooltip(){window.hideTooltip&&window.hideTooltip()}get isTutorialMode(){return this.tutorialMode}get isTutorialActive(){return this.isActive}get targetCount(){return 5}};window.tutorialManager=r;class d{constructor(){this.sidenav=document.getElementById("sidenav"),this.toggleBtn=document.getElementById("sidenavToggle"),this.closeBtn=document.getElementById("sidenavClose"),this.infoBtn=document.getElementById("infoBtn"),this.resetTutorialBtn=document.getElementById("resetTutorialBtn"),this.appInfoModal=document.getElementById("appInfoModal"),this.closeAppInfoBtn=document.getElementById("closeAppInfoBtn"),this.isOpen=!1,this.init()}init(){this.setupEventListeners(),this.setupTooltips()}setupEventListeners(){this.toggleBtn.addEventListener("click",()=>{o.bounce(this.toggleBtn,1.1,120),a.trigger("light"),this.toggle()}),this.closeBtn.addEventListener("click",()=>{o.press(this.closeBtn,.9,100),a.trigger("light"),this.close()}),this.infoBtn.addEventListener("click",()=>{o.bounce(this.infoBtn,1.1,120),a.trigger("light"),this.openAppInfoModal()}),this.resetTutorialBtn.addEventListener("click",()=>{o.bounce(this.resetTutorialBtn,1.1,120),a.trigger("medium"),this.resetTutorial()}),this.closeAppInfoBtn.addEventListener("click",()=>{o.press(this.closeAppInfoBtn,.95,100),a.trigger("light"),this.closeAppInfoModal()}),this.appInfoModal.addEventListener("click",e=>{e.target===this.appInfoModal&&this.closeAppInfoModal()}),document.addEventListener("click",e=>{!this.isOpen||this.sidenav.contains(e.target)||this.toggleBtn.contains(e.target)||this.close()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.appInfoModal&&!this.appInfoModal.classList.contains("hidden")?this.closeAppInfoModal():this.isOpen&&this.close())})}setupTooltips(){this.infoBtn.addEventListener("mouseenter",()=>{window.showTooltip&&window.innerWidth>=640&&window.showTooltip("App information",this.infoBtn)}),this.infoBtn.addEventListener("mouseleave",()=>{window.hideTooltip&&window.innerWidth>=640&&window.hideTooltip()}),this.resetTutorialBtn.addEventListener("mouseenter",()=>{window.showTooltip&&window.innerWidth>=640&&window.showTooltip("Reset tutorial",this.resetTutorialBtn)}),this.resetTutorialBtn.addEventListener("mouseleave",()=>{window.hideTooltip&&window.innerWidth>=640&&window.hideTooltip()}),this.toggleBtn.addEventListener("mouseenter",()=>{if(window.showTooltip&&window.innerWidth>=640){const e=this.isOpen?"Close side panel":"Open side panel";window.showTooltip(e,this.toggleBtn)}}),this.toggleBtn.addEventListener("mouseleave",()=>{window.hideTooltip&&window.innerWidth>=640&&window.hideTooltip()}),this.closeBtn.addEventListener("mouseenter",()=>{window.showTooltip&&window.innerWidth>=640&&window.showTooltip("Close side panel",this.closeBtn)}),this.closeBtn.addEventListener("mouseleave",()=>{window.hideTooltip&&window.innerWidth>=640&&window.hideTooltip()})}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen=!0,this.sidenav.classList.remove("translate-x-full"),this.sidenav.classList.add("translate-x-0"),this.updateToggleButton()}close(){this.isOpen=!1,this.sidenav.classList.remove("translate-x-0"),this.sidenav.classList.add("translate-x-full"),this.updateToggleButton(),window.hideTooltip&&window.hideTooltip()}updateToggleButton(){const e=this.toggleBtn.querySelector("svg path");this.isOpen?(e.setAttribute("d","M15 19l-7-7 7-7"),this.toggleBtn.setAttribute("title","Close side panel"),this.toggleBtn.setAttribute("aria-label","Close side panel")):(e.setAttribute("d","M9 5l7 7-7 7"),this.toggleBtn.setAttribute("title","Open side panel"),this.toggleBtn.setAttribute("aria-label","Open side panel"))}async resetTutorial(){try{if(!(await r.resetTutorial()))throw new Error("Failed to reset tutorial");window.showTooltip&&(window.showTooltip("Tutorial reset! Reload page to see tutorial.",this.resetTutorialBtn),setTimeout(()=>{window.hideTooltip&&window.hideTooltip()},3e3)),setTimeout(()=>{confirm("Tutorial has been reset! Would you like to reload the page to see the tutorial?")&&window.location.reload()},500)}catch(e){window.showTooltip&&(window.showTooltip("Error resetting tutorial. Please try again.",this.resetTutorialBtn),setTimeout(()=>{window.hideTooltip&&window.hideTooltip()},3e3))}}openAppInfoModal(){this.appInfoModal&&(this.appInfoModal.classList.remove("hidden"),this.appInfoModal.classList.add("flex"),this.appInfoModal.setAttribute("aria-hidden","false"),this.close(),setTimeout(()=>{this.closeAppInfoBtn.focus()},100))}closeAppInfoModal(){this.appInfoModal&&(this.appInfoModal.classList.add("hidden"),this.appInfoModal.classList.remove("flex"),this.appInfoModal.setAttribute("aria-hidden","true"),this.infoBtn.focus())}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.sidenavManager=new d}):window.sidenavManager=new d;const c=document.getElementById("soundCanvas"),h=c.getContext("2d"),u=window.devicePixelRatio||1;let m=-1,g=new Map;const w=new Audio("./assets/5.mp3"),p=[{dirX:0,dirY:-1,audio:new Audio("./assets/2.mp3")},{dirX:0,dirY:1,audio:new Audio("./assets/8.mp3")},{dirX:-1,dirY:0,audio:new Audio("./assets/4.mp3")},{dirX:1,dirY:0,audio:new Audio("./assets/6.mp3")},{dirX:1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/3.mp3")},{dirX:-1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/1.mp3")},{dirX:-1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/7.mp3")},{dirX:1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/9.mp3")}];function f(){!function(){const e=c.clientWidth,t=c.clientHeight;c.width=e*u,c.height=t*u,h.resetTransform(),h.scale(u,u)}();const e=c.clientWidth,t=c.clientHeight,n=e/2,i=t/2,s=Math.min(e,t),o=.15*s*.4,a=.4*o,l=o+a+.12*s*.4;if(h.clearRect(0,0,e,t),h.beginPath(),h.arc(n,i,o,0,2*Math.PI),h.lineWidth=a,g.has(-1)){const{startTime:e,duration:t}=g.get(-1),n=T(e,t);if(n>0){const e=Math.floor(255*n),t=Math.floor(107*n),i=Math.floor(107*n);h.strokeStyle=`rgb(${e}, ${t}, ${i})`}else{const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.strokeStyle="dark"===e?"#fff":"#000",g.delete(-1)}}else{const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.strokeStyle="dark"===e?"#fff":"#000"}if(h.stroke(),-1===m){h.beginPath(),h.arc(n,i,o+a/2+4,0,2*Math.PI);const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.strokeStyle="dark"===e?"#FFF176":"#F57F17",h.lineWidth=3,h.setLineDash([5,5]),h.stroke(),h.setLineDash([])}[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2}].forEach((e,t)=>{for(let s=1;s<=3;s++){const o=n+e.x*l*s,r=i+e.y*l*s,d=3*t+(s-1);if(h.beginPath(),h.arc(o,r,a,0,2*Math.PI),g.has(d)){const{startTime:e,duration:t}=g.get(d),n=T(e,t);if(n>0){const e=Math.floor(255*n),t=Math.floor(107*n),i=Math.floor(107*n);h.fillStyle=`rgb(${e}, ${t}, ${i})`,h.fill(),h.strokeStyle="#fff",h.lineWidth=2,h.stroke()}else{g.delete(d);const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.fillStyle="dark"===e?"#fff":"#000",h.fill()}}else{const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.fillStyle="dark"===e?"#fff":"#000",h.fill()}if(m===d){h.beginPath(),h.arc(o,r,a+4,0,2*Math.PI);const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";h.strokeStyle="dark"===e?"#FFF176":"#F57F17",h.lineWidth=3,h.setLineDash([3,3]),h.stroke(),h.setLineDash([])}}})}let y=[];function M(){const e=document.getElementById("canvas-announcements");if(e)if(-1===m)e.textContent="Center circle selected. Press space or enter to play center sound.";else{const t=["top","bottom","left","right","top-right","top-left","bottom-left","bottom-right"][m%8],n=Math.floor(m/8)+1;e.textContent=`${t} circle, ring ${n} selected. Press space or enter to play sound.`}}function T(e,t){const n=Date.now()-e,i=Math.min(n/t,1);return Math.max(0,1-i)*(.3*Math.sin(4*n/100)+.7)}c.addEventListener("click",e=>{const t=c.getBoundingClientRect(),n=c.clientWidth,i=c.clientHeight,s=e.clientX-t.left,l=e.clientY-t.top,r=n/2,d=i/2,h=Math.min(n,i),u=.15*h*.4;if((s-r)**2+(l-d)**2<=u*u)return o.canvasRipple(c,s,l),a.trigger("medium"),y.push({x:r,y:d,radius:u,alpha:1}),w.currentTime=0,void w.play();const m=.4*u,g=u+m+.12*h*.4;for(const{dirX:w,dirY:f,audio:y}of p)for(let e=1;e<=3;e++){if((s-(r+w*g*e))**2+(l-(d+f*g*e))**2<=m*m)return o.canvasRipple(c,s,l),a.trigger("light"),y.currentTime=0,void y.play()}}),c.addEventListener("keydown",e=>{switch(document.getElementById("canvas-announcements"),e.key){case"ArrowUp":e.preventDefault(),m=Math.max(-1,m-8),M(),f();break;case"ArrowDown":e.preventDefault(),m=Math.min(23,m+8),M(),f();break;case"ArrowLeft":e.preventDefault(),m=-1===m?21:(m-1+24)%24,M(),f();break;case"ArrowRight":e.preventDefault(),m=-1===m?0:(m+1)%24,M(),f();break;case" ":case"Enter":e.preventDefault(),function(){if(-1===m){Math.min(c.clientWidth,c.clientHeight);const e=c.clientWidth/2,t=c.clientHeight/2;o.canvasRipple(c,e,t),a.trigger("medium"),w.currentTime=0,w.play();const n=document.getElementById("canvas-announcements");n&&(n.textContent="Center circle activated. Water drop sound played.")}else{const e=m%8,t=[0,1,2,3,4,5,7,6][e],{audio:n,dirX:i,dirY:s}=p[t],l=Math.min(c.clientWidth,c.clientHeight),r=.4,d=.15*l*r,h=d+.4*d+.12*l*r,u=Math.floor(m/8)+1,g=c.clientWidth/2+i*h*u,w=c.clientHeight/2+s*h*u;o.canvasRipple(c,g,w),a.trigger("light"),n.currentTime=0,n.play();const f=document.getElementById("canvas-announcements");if(f){const t=["top","bottom","left","right","top-right","top-left","bottom-left","bottom-right"][e];f.textContent=`${t} circle activated. Clicking sound played.`}}}();break;case"Home":e.preventDefault(),m=-1,M(),f()}}),window.canvasHighlight={highlightCircle:function(e,t=500){const n=Date.now();g.set(e,{startTime:n,duration:t})},clearAllHighlights:function(){g.clear()}},function e(){f(),function(){const e=.006*Math.min(c.clientWidth,c.clientHeight),t="dark"===(window.themeManager?window.themeManager.getEffectiveTheme():"light")?"255,255,255":"0,0,0";y.forEach((n,i)=>{h.beginPath(),h.arc(n.x,n.y,n.radius,0,2*Math.PI),h.strokeStyle=`rgba(${t},${n.alpha})`,h.lineWidth=2,h.stroke(),n.radius+=e,n.alpha-=.016,n.alpha<=0&&y.splice(i,1)})}(),requestAnimationFrame(e)}();const v={ZERO:0,ONE:.25,TWO:.5,THREE:.75};let b=null;function S(){return b||(b=new(window.AudioContext||window.webkitAudioContext)),b}function E(e){const t=e%3;return{radian:t+1,direction:Math.floor(e/3),position:t}}async function L(e,t={}){if(!e||0===e.length)return;const{inModal:n=!1}=t,i=S();"suspended"===i.state&&await i.resume(),window.canvasHighlight&&window.canvasHighlight.clearAllHighlights(),n&&window.modalHighlight&&window.modalHighlight.clearModalHighlights();const s={0:[],1:[],2:[],3:[]};e.forEach(e=>{const{radian:t}=E(e);s[t].push(e)}),function(){if(y&&c){const e=c.clientWidth/2,t=c.clientHeight/2,n=.15*Math.min(c.clientWidth,c.clientHeight)*.4;y.push({x:e,y:t,radius:n,alpha:1})}}(),n&&window.modalHighlight&&window.modalHighlight.createModalRipple(),w&&setTimeout(()=>{w.currentTime=0,w.play().catch(e=>{}),window.canvasHighlight&&window.canvasHighlight.highlightCircle(-1,400),n&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(-1,400)},0),Object.keys(s).forEach(e=>{const t=s[e];if(0===t.length)return;const i=parseInt(e),o=1e3*v[Object.keys(v)[i]];t.forEach((e,t)=>{const s=function(e){const t=Math.floor(e/3);return p[t]?p[t].audio:null}(e);if(s){setTimeout(()=>{s.currentTime=0,s.play().catch(e=>{}),a.radianFeedback(i),window.canvasHighlight&&window.canvasHighlight.highlightCircle(e,600),n&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(e,600)},o+.01*t*1e3)}})})}let k=new Map;function B(e,t){return e||JSON.stringify(t)}function x(e,t,n=null){const i=B(n,e);if(k.has(i)){const e=k.get(i);clearInterval(e.timer),k.delete(i),q(),C()}else{if(k.size>=5){const e=document.getElementById("loopCounter");if(e){const t=e.className;e.className=e.className.replace(/bg-\S+/g,"bg-red-200 dark:bg-red-800"),e.style.animation="pulse 0.5s ease-in-out 2",setTimeout(()=>{e.className=t,e.style.animation=""},1e3)}return}L(e);const s=setInterval(async()=>{try{await L(e)}catch(i){x(e,t,n)}},1e3*t);k.set(i,{timer:s,sequence:e,interval:t,thumbnail:n}),q(),C()}}function I(e,t=null){if(!e)return!1;const n=B(t,e);return k.has(n)}function C(){const e=document.getElementById("loopCounter");if(!e)return;const t=k.size;t>0?(e.textContent=`Loops playing: ${t}/5`,e.classList.remove("hidden")):e.classList.add("hidden")}function q(){const e=document.getElementById("sequenceBar");if(!e)return;e.querySelectorAll("canvas").forEach(e=>{const t=e.sequenceData;if(t){const n=I(t.seq,e),i=document.documentElement.classList.contains("dark");e.classList.remove("bg-swarmstripe-200/50","bg-swarmshadow-50","rounded-lg","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),e.style.backgroundColor="",e.style.animation="",n&&(e.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),i?e.classList.add("bg-swarmshadow-50"):e.classList.add("bg-swarmstripe-200/50"),e.style.animation="loop-pulse 2s ease-in-out infinite")}})}!function e(){if("loading"===document.readyState)return void document.addEventListener("DOMContentLoaded",e);const t=document.getElementById("sequenceBar");t?t.addEventListener("click",async e=>{const n=e.target.closest("canvas");if(!n)return;let s,l,r,d;if(o.bounce(n,1.1,120),a.trigger("light"),n.sequenceData)s=n.sequenceData;else{const e=Array.from(t.children).indexOf(n);try{s=(await i())[e]}catch(c){return}}if(s){Array.isArray(s)?(l=s,r=!1,d=3):(l=s.seq||s.sequence,r=s.isLoop||!1,d=s.loopInterval||3);try{r?x(l,d,n):await L(l)}catch(c){}}}):setTimeout(e,100)}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",C):C(),window.audioSystem={playSequence:L,initAudioContext:S,toggleLoopPlayback:x,isSequenceLooping:I,updateThumbnailLoopStates:q,updateLoopCounter:C,getRadianInfo:E,RADIAN_TIMING:v,MAX_CONCURRENT_LOOPS:5,getActiveLoopCount:()=>k.size};const A=document.getElementById("tooltip");function R(){A.classList.add("hidden"),A.setAttribute("aria-hidden","true")}function D(){if(window.themeManager){const e=window.themeManager.getEffectiveTheme(),t=document.documentElement.classList.contains("dark");if("dark"===e&&t||"light"===e&&!t)return e}return document.documentElement.classList.contains("dark")?"dark":document.documentElement.classList.contains("light")?"light":window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}async function W(e,t=null){const n=document.getElementById("sequenceBar"),i=80,s=document.createElement("canvas");s.width=i*u,s.height=i*u,s.style.width="80px",s.style.height="80px";const o=s.getContext("2d");let a,l,r;o.scale(u,u),Array.isArray(e)?(a=e,l=!1,r=3):(a=e.sequence||e,l=e.isLoop||!1,r=e.loopInterval||3);const d=6.16,c=.35*d,h=1.8*d;o.beginPath(),o.arc(40,40,d,0,2*Math.PI);const m="dark"===D()?"#fff":"#000";if(window.location.hostname,o.fillStyle=m,o.fill(),p.forEach(({dirX:e,dirY:t,audio:n},i)=>{for(let s=1;s<=3;s++){const n=3*[0,1,2,3,4,5,7,6].indexOf(i)+(s-1),l=a.includes(n),r=40+e*h*s,d=40+t*h*s;if(r-c>=3&&r+c<=77&&d-c>=3&&d+c<=77){o.beginPath(),o.arc(r,d,c,0,2*Math.PI);const e=D(),t="dark"===e?"#fff":"#000",n="dark"===e?"#000":"#fff";o.fillStyle=t,o.strokeStyle=n,o.lineWidth=.5,l?o.fill():o.stroke()}}}),s.sequenceData={seq:a,isLoop:l,loopInterval:r},s.sequenceIndex=t,window.audioSystem&&window.audioSystem.isSequenceLooping&&window.audioSystem.isSequenceLooping(a,s)){const e="dark"===D();s.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","p-2"),e?s.classList.add("bg-swarmshadow-50"):s.classList.add("bg-swarmstripe-200/50"),s.style.animation="loop-pulse 2s ease-in-out infinite"}n.appendChild(s)}function H(){document.getElementById("sequenceBar").querySelectorAll("canvas").forEach(e=>e.remove()),i().then(e=>{e.forEach((e,t)=>W(e,t))}).catch(e=>{})}function P(){!function e(){if(window.themeManager&&window.themeManager.initialized){const t=window.themeManager.getEffectiveTheme(),n=document.documentElement.classList.contains("dark"),s=document.documentElement.classList.contains("light");"dark"===t&&n||"light"===t&&(s||!n&&!s)?i().then(e=>{e.forEach((e,t)=>W(e,t))}).catch(e=>{}):requestAnimationFrame(e)}else window.addEventListener("themeManagerReady",()=>{requestAnimationFrame(e)},{once:!0})}()}window.showTooltip=function(e,t,n=0){const i=t.getBoundingClientRect(),s=window.innerWidth,o=window.innerHeight;A.textContent=e;const a=null!==t.closest("#sequenceModal"),l=void 0!==window.__TAURI__;let r,d;if(a||s<640){const e=A.offsetWidth||200;if(a){const t=document.getElementById("modalContent").getBoundingClientRect();r=t.left+(t.width-e)/2,d=t.top-40,d<16&&(d=t.top+8)}else r=(s-e)/2,d=i.bottom+8;r=Math.max(8,Math.min(r,s-e-8)),d=Math.max(8,Math.min(d,o-50))}else if(r=i.left+i.width/2-A.offsetWidth/2+n,d=i.bottom+16,l){const e=A.offsetWidth||200,t=A.offsetHeight||40;r=Math.max(16,Math.min(r,s-e-16)),d=Math.max(16,Math.min(d,o-t-16));const n=i.left+i.width/2,a=100;Math.abs(r+e/2-n)>a&&(r=n-e/2,r=Math.max(16,Math.min(r,s-e-16)))}else{const e=A.offsetWidth||200;r=Math.max(8,Math.min(r,s-e-8))}A.style.left=r+"px",A.style.top=d+"px",A.classList.remove("hidden"),A.removeAttribute("aria-hidden")},window.hideTooltip=R,document.addEventListener("DOMContentLoaded",function(){if(window.themeManager&&window.themeManager.initialized){const e=window.themeManager.setTheme.bind(window.themeManager);window.themeManager.setTheme=async function(t){await e(t),H()}}else window.addEventListener("themeManagerReady",()=>{const e=window.themeManager.setTheme.bind(window.themeManager);window.themeManager.setTheme=async function(t){await e(t),H()}},{once:!0})}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",P):P();class O{constructor(){this.contextMenu=null,this.currentThumbnail=null,this.init()}init(){this.contextMenu=document.getElementById("contextMenu"),this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",e=>{this.contextMenu.contains(e.target)||this.hideContextMenu()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.hideContextMenu()}),document.getElementById("editSequence").addEventListener("click",()=>{o.press(document.getElementById("editSequence"),.95,100),a.trigger("light"),this.editSequence(),this.hideContextMenu()}),document.getElementById("deleteSequence").addEventListener("click",()=>{o.press(document.getElementById("deleteSequence"),.95,100),a.trigger("medium"),this.deleteSequence(),this.hideContextMenu()});const e=document.getElementById("sequenceBar");e&&e.addEventListener("contextmenu",e=>{const t=e.target.closest("canvas");t&&t.sequenceData&&(e.preventDefault(),this.showContextMenu(e,t))})}showContextMenu(e,t){this.currentThumbnail=t,this.contextMenu.style.visibility="hidden",this.contextMenu.classList.remove("hidden");const n=this.contextMenu.getBoundingClientRect(),i=n.width,s=n.height,o=window.innerWidth,a=window.innerHeight;let l=e.clientX,r=e.clientY;l+i+8>o&&(l-=i,l<8&&(l=o-i-8)),l=Math.max(8,l),r+s+8>a&&(r-=s,r<8&&(r=a-s-8)),r=Math.max(8,r);const d=document.getElementById("sequenceBar");if(d){const t=d.getBoundingClientRect();e.clientY>=t.top&&r+s>t.top&&(r=Math.max(8,t.top-s-4))}this.contextMenu.style.left=l+"px",this.contextMenu.style.top=r+"px",this.contextMenu.style.visibility="visible"}hideContextMenu(){this.contextMenu.classList.add("hidden"),this.contextMenu.style.visibility="",this.currentThumbnail=null}editSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const e=this.currentThumbnail.sequenceData;this.currentThumbnail.setAttribute("data-editing","true"),window.modalManager&&window.modalManager.openEditMode(e,this.currentThumbnail)}async deleteSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const t=this.currentThumbnail,n=this.currentThumbnail.sequenceData;if(confirm("Are you sure you want to delete this sequence? This action cannot be undone."))try{const s=(await i()).findIndex(e=>{const t=Array.isArray(e)?e:e.sequence||e.seq,i=Array.isArray(n)?n:n.sequence||n.seq;return JSON.stringify(t)===JSON.stringify(i)});if(-1!==s){if(await async function(t){const n=(await e()).transaction("sequences","readwrite").objectStore("sequences");return new Promise((e,i)=>{const s=n.getAll();s.onsuccess=()=>{const o=s.result||[];if(t>=0&&t<o.length){const s=n.clear();s.onsuccess=()=>{const s=o.filter((e,n)=>n!==t);let a=0;0!==s.length?s.forEach((t,o)=>{const l=n.add(t,o+1);l.onsuccess=()=>{a++,a===s.length&&e()},l.onerror=()=>{i(l.error)}}):e()},s.onerror=()=>{i(s.error)}}else i(new Error("Invalid sequence index"))},s.onerror=()=>{i(s.error)}})}(s),t.remove(),window.audioSystem&&window.audioSystem.isSequenceLooping){const e=Array.isArray(n)?n:n.sequence||n.seq;if(window.audioSystem.isSequenceLooping(e,t)){const i=n.loopInterval||3;window.audioSystem.toggleLoopPlayback(e,i,t)}}}else alert("Sequence not found in storage. It may have already been deleted.")}catch(s){alert("Failed to delete sequence. Please try again.")}}}document.addEventListener("DOMContentLoaded",()=>{window.contextMenuManager=new O});const Q=document.getElementById("createSequenceBtn"),F=document.getElementById("sequenceModal"),$=document.getElementById("sequenceCanvas"),N=$.getContext("2d"),X=document.getElementById("modalTitle");let _=new Map,Y=[];class j{constructor(){this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,this.originalSequenceIndex=null,this.init()}init(){this.setupEventListeners()}setupEventListeners(){Q.addEventListener("click",()=>{o.bounce(Q,1.05,150),a.trigger("medium"),this.openCreateMode()})}async openCreateMode(){R(),Q.classList.remove("highlight-once"),document.body.classList.remove("tutorial-active"),this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,this.originalSequenceIndex=null,X.textContent="Create New Sequence";await t("tutorialSeen")?r.disableTutorialMode():r.enableTutorialMode(),this.resetModalState(),this.showModal()}openEditMode(e,t){this.isEditMode=!0,this.editingThumbnail=t,this.originalSequenceData=JSON.parse(JSON.stringify(e)),this.originalSequenceIndex=t.sequenceIndex,X.textContent="Edit Sequence",r.disableTutorialMode(),this.resetModalState(),this.showModal(),this.loadSequenceIntoModal(e),te(),se()}resetModalState(){Z.forEach(e=>{e.clicked=!1}),K.checked=!1,J.value=3,G.style.opacity="0.5",J.disabled=!0,_.clear(),Y.length=0,r.cleanupTutorialState()}loadSequenceIntoModal(e){const t=Array.isArray(e)?e:e.seq||e.sequence||[],n=e.isLoop||!1,i=e.loopInterval||3;K.checked=n,J.value=i,n&&(G.style.opacity="1",J.disabled=!1),t.forEach(e=>{Z[e]&&(Z[e].clicked=!0)})}showModal(){F.classList.remove("hidden"),F.classList.add("flex"),F.setAttribute("aria-hidden","false"),V=-1,this.initializeModalCircles(),te(),ne(),r.isTutorialMode&&r.updateTutorialUI(0),se(),setTimeout(()=>{$.focus()},100)}initializeModalCircles(){const e=$.clientWidth,t=$.clientHeight,n=250,i=(e-n)/2,s=(t-n)/2,o=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2}];Z=[],o.forEach((e,t)=>{const n=p[[0,1,2,3,4,5,7,6][t]].audio;for(let o=1;o<=3;o++)Z.push({x:i+125+36*e.x*o,y:s+125+36*e.y*o,r:6.75,audio:n,clicked:!1})})}}const z=document.getElementById("testSequenceBtn"),U=document.getElementById("saveSequenceBtn"),K=document.getElementById("loopToggle"),J=document.getElementById("loopInterval"),G=document.getElementById("loopIntervalControls");let Z=[],V=-1;const ee=new j;function te(){!function(){const e=$.clientWidth,t=$.clientHeight;$.width=e*u,$.height=t*u,N.resetTransform(),N.scale(u,u)}();const e=$.clientWidth,t=$.clientHeight,n=Math.min(250,250);N.clearRect(0,0,e,t),N.save();const i=(e-n)/2,s=(t-n)/2;N.translate(i,s);const o=n/2,a=n/2;!function(){const e="dark"===(window.themeManager?window.themeManager.getEffectiveTheme():"light")?"255,255,255":"0,0,0";Y.forEach((t,n)=>{N.beginPath(),N.arc(t.x,t.y,t.radius,0,2*Math.PI),N.strokeStyle=`rgba(${e},${t.alpha})`,N.lineWidth=2,N.stroke(),t.radius+=4,t.alpha-=.04,t.alpha<=0&&Y.splice(n,1)})}();const l=.09*n;if(N.beginPath(),N.arc(o,a,l,0,2*Math.PI),_.has(-1)){const{startTime:e,duration:t}=_.get(-1),n=le(e,t);if(n>0){const e=Math.floor(255*n),t=Math.floor(107*n),i=Math.floor(107*n);N.fillStyle=`rgb(${e}, ${t}, ${i})`}else{const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";N.fillStyle="dark"===e?"#fff":"#000",_.delete(-1)}}else{const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";N.fillStyle="dark"===e?"#fff":"#000"}if(N.fill(),-1===V){N.beginPath(),N.arc(o,a,l+4,0,2*Math.PI);const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";N.strokeStyle="dark"===e?"#FFF176":"#F57F17",N.lineWidth=3,N.setLineDash([3,3]),N.stroke(),N.setLineDash([])}const r=.3*l,d=l+2*r;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2}].forEach((e,t)=>{var n;for(let i=1;i<=3;i++){const s=o+e.x*d*i,l=a+e.y*d*i,c=3*t+(i-1);N.beginPath(),N.arc(s,l,r,0,2*Math.PI);const h=null==(n=Z[c])?void 0:n.clicked;if(_.has(c)){const{startTime:e,duration:t}=_.get(c),n=le(e,t);if(n>0){const e=Math.floor(255*n),t=Math.floor(107*n),i=Math.floor(107*n);N.fillStyle=`rgb(${e}, ${t}, ${i})`,N.fill(),N.strokeStyle="#fff",N.lineWidth=2,N.stroke()}else{_.delete(c);const e="dark"===(window.themeManager?window.themeManager.getEffectiveTheme():"light")?"#fff":"#000";h?(N.fillStyle=e,N.fill()):(N.strokeStyle=e,N.lineWidth=2,N.stroke())}}else{const e="dark"===(window.themeManager?window.themeManager.getEffectiveTheme():"light")?"#fff":"#000";h?(N.fillStyle=e,N.fill()):(N.strokeStyle=e,N.lineWidth=2,N.stroke())}if(V===c){N.beginPath(),N.arc(s,l,r+3,0,2*Math.PI);const e=window.themeManager?window.themeManager.getEffectiveTheme():"light";N.strokeStyle="dark"===e?"#FFF176":"#F57F17",N.lineWidth=2,N.setLineDash([2,2]),N.stroke(),N.setLineDash([])}}}),N.restore()}function ne(){F.classList.contains("hidden")||(te(),requestAnimationFrame(ne))}function ie(){const e=document.getElementById("canvas-announcements");if(e)if(-1===V)e.textContent="Center circle selected in sequence editor. Press space or enter to select/deselect.";else{const t=["top","bottom","left","right","top-right","top-left","bottom-left","bottom-right"][V%8],n=Math.floor(V/8)+1,i=Z[V],s=(null==i?void 0:i.clicked)?"selected":"unselected";e.textContent=`${t} circle, ring ${n} - currently ${s}. Press space or enter to toggle.`}}function se(){const e=Z.filter(e=>e.clicked).length;r.updateButtonStates(e)||(e>0?(z.disabled=!1,U.disabled=!1):(z.disabled=!0,U.disabled=!0))}function oe(){R(),F.classList.add("hidden"),F.classList.remove("flex"),F.setAttribute("aria-hidden","true"),window.modalManager.isEditMode&&window.modalManager.editingThumbnail&&window.modalManager.editingThumbnail.removeAttribute("data-editing"),window.modalManager.isEditMode=!1,window.modalManager.editingThumbnail=null,window.modalManager.originalSequenceData=null,window.modalManager.originalSequenceIndex=null,Z.forEach(e=>e.clicked=!1),z.disabled=!0,z.classList.remove("highlight-once"),U.disabled=!0,r.cleanupTutorialState(),K.checked=!1,J.value=3,J.disabled=!0,G.style.opacity="0.5",window.modalHighlight&&window.modalHighlight.clearModalHighlights(),Y.length=0,te()}window.modalManager=ee,window.modalHighlight={highlightModalCircle:function(e,t=600){const n=Date.now();_.set(e,{startTime:n,duration:t})},clearModalHighlights:function(){_.clear()},createModalRipple:function(){Y.push({x:125,y:125,radius:22.5,alpha:1})},startAnimation:ne},$.addEventListener("click",async e=>{const t=$.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,s=$.clientWidth,l=$.clientHeight,r=250,d=(s-r)/2,c=(l-r)/2,h=n-d,u=i-c,m=6.75;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2}].forEach((e,t)=>{for(let n=1;n<=3;n++){const i=125+36*e.x*n,s=125+36*e.y*n,l=Z[3*t+(n-1)];if(l&&(h-i)**2+(u-s)**2<=m*m){l.clicked=!l.clicked;const e=$.getBoundingClientRect(),t=($.closest('[id*="container"]')||$.parentElement).getBoundingClientRect(),n=i+d+(e.left-t.left),r=s+c+(e.top-t.top);return o.canvasRipple($,n,r),a.trigger(l.clicked?"medium":"light"),l.clicked&&(l.audio.currentTime=0,l.audio.play()),se(),void te()}}})}),$.addEventListener("keydown",e=>{if(!F.classList.contains("hidden"))switch(e.key){case"ArrowUp":e.preventDefault(),V=Math.max(-1,V-8),ie(),te();break;case"ArrowDown":e.preventDefault(),V=Math.min(23,V+8),ie(),te();break;case"ArrowLeft":e.preventDefault(),V=-1===V?21:(V-1+24)%24,ie(),te();break;case"ArrowRight":e.preventDefault(),V=-1===V?0:(V+1)%24,ie(),te();break;case" ":case"Enter":e.preventDefault(),function(){if(-1===V){const e=document.getElementById("canvas-announcements");e&&(e.textContent="Center circle cannot be selected in sequence editor.")}else{const e=Z[V];if(e){e.clicked=!e.clicked,a.trigger(e.clicked?"medium":"light"),e.clicked&&(e.audio.currentTime=0,e.audio.play()),se(),te();const t=document.getElementById("canvas-announcements");if(t){const n=["top","bottom","left","right","top-right","top-left","bottom-left","bottom-right"][V%8],i=Math.floor(V/8)+1,s=e.clicked?"selected":"deselected";t.textContent=`${n} circle, ring ${i} ${s}.`}}}}();break;case"Home":e.preventDefault(),V=-1,ie(),te()}}),z.addEventListener("click",async e=>{o.press(z,.95,100),a.trigger("medium"),await r.handleTestClick();const t=Z.map((e,t)=>e.clicked?t:null).filter(e=>null!==e);if(t.length>0)try{window.audioSystem&&window.audioSystem.playSequence&&await window.audioSystem.playSequence(t,{inModal:!0}),r.isTutorialMode||(U.disabled=!1)}catch(n){r.isTutorialMode||(U.disabled=!1)}}),K.addEventListener("change",()=>{const e=K.checked;J.disabled=!e,e?G.classList.remove("opacity-50"):G.classList.add("opacity-50")}),U.addEventListener("click",async()=>{o.press(U,.95,100),a.trigger("success");const t={sequence:Z.map((e,t)=>e.clicked?t:null).filter(e=>null!==e),isLoop:K.checked,loopInterval:parseInt(J.value)||3};try{if(window.modalManager.isEditMode){if(null===window.modalManager.originalSequenceIndex)throw new Error("Original sequence index not available");if(await async function(t,n){const i=(await e()).transaction("sequences","readwrite").objectStore("sequences");return new Promise((e,s)=>{const o=i.getAll();o.onsuccess=()=>{const a=o.result||[];if(t>=0&&t<a.length){const o=i.put(n,t+1);o.onsuccess=()=>{e()},o.onerror=()=>{s(o.error)}}else s(new Error("Invalid sequence index"))},o.onerror=()=>{s(o.error)}})}(window.modalManager.originalSequenceIndex,t),window.audioSystem&&window.audioSystem.isSequenceLooping){const e=Array.isArray(window.modalManager.originalSequenceData)?window.modalManager.originalSequenceData:window.modalManager.originalSequenceData.sequence||window.modalManager.originalSequenceData.seq;if(window.audioSystem.isSequenceLooping(e,window.modalManager.editingThumbnail)){const t=window.modalManager.originalSequenceData.loopInterval||3;window.audioSystem.toggleLoopPlayback(e,t,window.modalManager.editingThumbnail)}}window.modalManager.editingThumbnail.removeAttribute("data-editing"),window.modalManager.editingThumbnail.remove(),W(t,window.modalManager.originalSequenceIndex)}else{await async function(t){const n=(await e()).transaction("sequences","readwrite");let i;i=Array.isArray(t)?{sequence:t,isLoop:!1,loopInterval:3}:t,n.objectStore("sequences").add(i)}(t);const n=await i();W(t,n.length-1)}await r.handleSaveClick(),oe()}catch(n){alert("Failed to save sequence. Please try again.")}});const ae=document.getElementById("closeModalBtn");ae.addEventListener("click",()=>{o.press(ae,.9,100),a.trigger("light"),oe()}),F.addEventListener("click",e=>{e.target===F&&oe()});function le(e,t){const n=Date.now()-e,i=Math.min(n/t,1);return Math.max(0,1-i)*(.3*Math.sin(4*n/100)+.7)}document.getElementById("modalContent").addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{"Escape"!==e.key||F.classList.contains("hidden")||oe()}),window.modalManager=new j;class re{constructor(){this.highContrastMode="true"===localStorage.getItem("swarm-high-contrast"),this.init()}init(){this.highContrastMode&&this.enableHighContrast();const e=document.getElementById("highContrastBtn");e&&e.addEventListener("click",()=>{this.toggleHighContrast()}),document.addEventListener("keydown",e=>{e.ctrlKey&&e.altKey&&"c"===e.key&&(e.preventDefault(),this.toggleHighContrast())}),this.addKeyboardShortcutInstructions()}toggleHighContrast(){this.highContrastMode=!this.highContrastMode,localStorage.setItem("swarm-high-contrast",this.highContrastMode.toString()),this.highContrastMode?this.enableHighContrast():this.disableHighContrast(),this.announceContrastChange()}enableHighContrast(){document.body.classList.add("high-contrast");const e=document.getElementById("highContrastBtn");e&&(e.setAttribute("aria-pressed","true"),e.title="Disable high contrast mode")}disableHighContrast(){document.body.classList.remove("high-contrast");const e=document.getElementById("highContrastBtn");e&&(e.setAttribute("aria-pressed","false"),e.title="Enable high contrast mode")}announceContrastChange(){const e=document.getElementById("canvas-announcements");e&&(e.textContent=this.highContrastMode?"High contrast mode enabled":"High contrast mode disabled")}addKeyboardShortcutInstructions(){const e=document.createElement("div");e.className="sr-only",e.innerHTML="\n      <h3>Keyboard Shortcuts</h3>\n      <ul>\n        <li>Ctrl+Alt+C: Toggle high contrast mode</li>\n        <li>Arrow keys: Navigate sound grid</li>\n        <li>Space/Enter: Activate sounds</li>\n        <li>Home: Return to center circle</li>\n        <li>Tab: Navigate interface elements</li>\n        <li>Escape: Close modals</li>\n      </ul>\n    ",document.body.appendChild(e)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.accessibilityManager=new re}):window.accessibilityManager=new re;
