(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();const De="modulepreload",Pe=function(n){return"/"+n},ge={},Oe=function(t,e,i){let o=Promise.resolve();if(e&&e.length>0){let a=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),r=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=a(e.map(l=>{if(l=Pe(l),l in ge)return;ge[l]=!0;const h=l.endsWith(".css"),u=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const d=document.createElement("link");if(d.rel=h?"stylesheet":De,h||(d.as="script"),d.crossOrigin="",d.href=l,r&&d.setAttribute("nonce",r),document.head.appendChild(d),h)return new Promise((m,w)=>{d.addEventListener("load",m),d.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(a){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=a,window.dispatchEvent(c),!c.defaultPrevented)throw a}return o.then(a=>{for(const c of a||[])c.status==="rejected"&&s(c.reason);return t().catch(s)})},Qe="clickRippleDB",He=1;function W(){return new Promise((n,t)=>{const e=indexedDB.open(Qe,He);e.onupgradeneeded=i=>{const o=i.target.result;o.objectStoreNames.contains("settings")||o.createObjectStore("settings"),o.objectStoreNames.contains("sequences")||o.createObjectStore("sequences",{autoIncrement:!0})},e.onsuccess=i=>n(i.target.result),e.onerror=i=>t(i.target.error)})}async function de(n){const t=await W();return new Promise(e=>{const o=t.transaction("settings","readonly").objectStore("settings").get(n);o.onsuccess=()=>e(o.result),o.onerror=()=>e(null)})}async function he(n,t){(await W()).transaction("settings","readwrite").objectStore("settings").put(t,n)}async function We(n){const e=(await W()).transaction("sequences","readwrite");let i;Array.isArray(n)?i={sequence:n,isLoop:!1,loopInterval:3}:i=n,e.objectStore("sequences").add(i)}async function N(){const n=await W();return new Promise(t=>{const i=n.transaction("sequences","readonly").objectStore("sequences").getAll();i.onsuccess=()=>t(i.result||[]),i.onerror=()=>t([])})}async function we(){return await de("preferences")||{theme:"system",volume:.7,showTutorial:!0}}async function Ne(n){await he("preferences",n)}async function Fe(n,t){const o=(await W()).transaction("sequences","readwrite").objectStore("sequences");return new Promise((s,a)=>{const c=o.getAll();c.onsuccess=()=>{const r=c.result||[];if(n>=0&&n<r.length){const l=o.put(t,n+1);l.onsuccess=()=>{console.log("Sequence updated successfully"),s()},l.onerror=()=>{console.error("Failed to update sequence:",l.error),a(l.error)}}else a(new Error("Invalid sequence index"))},c.onerror=()=>{console.error("Failed to get sequences for update:",c.error),a(c.error)}})}async function $e(n){const i=(await W()).transaction("sequences","readwrite").objectStore("sequences");return new Promise((o,s)=>{const a=i.getAll();a.onsuccess=()=>{const c=a.result||[];if(n>=0&&n<c.length){const r=i.clear();r.onsuccess=()=>{const l=c.filter((u,d)=>d!==n);let h=0;if(l.length===0){console.log("Sequence deleted successfully (store now empty)"),o();return}l.forEach((u,d)=>{const m=i.add(u,d+1);m.onsuccess=()=>{h++,h===l.length&&(console.log("Sequence deleted successfully"),o())},m.onerror=()=>{console.error("Failed to re-add sequence:",m.error),s(m.error)}})},r.onerror=()=>{console.error("Failed to clear store for deletion:",r.error),s(r.error)}}else s(new Error("Invalid sequence index"))},a.onerror=()=>{console.error("Failed to get sequences for deletion:",a.error),s(a.error)}})}class _e{constructor(){this.themes=["light","dark","system"],this.currentTheme="system",this.init()}async init(){await this.loadThemePreference(),this.applyTheme(this.currentTheme),this.setupEventListeners(),this.setupSystemThemeListener(),this.updateThemeButtons()}async loadThemePreference(){try{const t=await we();this.currentTheme=t.theme||"system"}catch{console.log("No stored theme preference, using system default"),this.currentTheme="system"}}async saveThemePreference(t){try{const e=await we();e.theme=t,await Ne(e)}catch(e){console.error("Failed to save theme preference:",e)}}setupEventListeners(){document.querySelectorAll("button[data-theme]").forEach(e=>{const i=e.dataset.theme;e.addEventListener("click",o=>{const s=o.currentTarget.dataset.theme;this.setTheme(s),window.innerWidth<640&&this.showMobileTooltip(e,s)}),e.addEventListener("mouseenter",o=>{window.innerWidth>=640&&this.showThemeTooltip(o.currentTarget,i)}),e.addEventListener("mouseleave",()=>{window.innerWidth>=640&&this.hideTooltip()})})}setupSystemThemeListener(){window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{this.currentTheme==="system"&&this.applySystemTheme()})}async setTheme(t){this.themes.includes(t)&&(this.currentTheme=t,await this.saveThemePreference(t),this.applyTheme(t),this.updateThemeButtons())}applyTheme(t){const e=document.documentElement;e.classList.remove("dark","light"),t==="dark"?e.classList.add("dark"):t==="light"?e.classList.add("light"):t==="system"&&this.applySystemTheme(),this.updateMetaThemeColor(t),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}applySystemTheme(){const t=document.documentElement,e=window.matchMedia("(prefers-color-scheme: dark)").matches;t.classList.remove("dark","light"),e?t.classList.add("dark"):t.classList.add("light"),window.audioSystem&&window.audioSystem.updateThumbnailLoopStates&&window.audioSystem.updateThumbnailLoopStates()}updateMetaThemeColor(t){const e=document.querySelector('meta[name="theme-color"]'),i=document.querySelector('meta[name="msapplication-TileColor"]');let o;t==="dark"||t==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches?o="#232323":o="#1F1F1F",e&&e.setAttribute("content",o),i&&i.setAttribute("content",o)}updateThemeButtons(){document.querySelectorAll("button[data-theme]").forEach(e=>{if(e.classList.remove("bg-swarmshadow-200","text-swarmlight-100","ring-2","ring-swarmlight-300","bg-swarmlight-300","text-swarmshadow-200","ring-swarmshadow-200","bg-swarmlight-200","text-black","text-white","font-semibold"),e.classList.remove("active"),e.dataset.theme===this.currentTheme){const i=e.dataset.theme,o=document.documentElement.classList.contains("dark");i==="dark"?e.classList.add("bg-swarmshadow-200","text-swarmlight-100"):i==="light"?e.classList.add("bg-swarmlight-300","text-swarmshadow-200"):i==="system"&&(e.classList.add("ring-2","font-semibold"),o?(e.classList.add("text-white","ring-swarmlight-600","dark:hover:text-swarmlight-50"),e.classList.remove("dark:hover:text-black")):e.classList.add("text-black","ring-swarmlight-300"),o?e.style.background="linear-gradient(45deg, #706A43 50%, #232323 50%)":e.style.background="linear-gradient(45deg, #FFFDE7 50%, #FFEE58 50%)"),i!=="system"&&(e.classList.add("ring-2"),o?e.classList.add("ring-swarmlight-600"):e.classList.add("ring-swarmlight-300"))}else e.dataset.theme==="system"&&(e.classList.add("dark:hover:text-black"),e.classList.remove("dark:hover:text-swarmlight-50"),e.style.background="")})}getCurrentTheme(){return this.currentTheme}getEffectiveTheme(){return this.currentTheme==="system"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":this.currentTheme}getThemeDescription(t){switch(t){case"light":return"Light theme - bright interface";case"dark":return"Dark theme - dark interface";case"system":return"System theme - follows your device settings";default:return"Theme option"}}showThemeTooltip(t,e){const i=this.getThemeDescription(e);if(window.showTooltip){const s=t.closest(".theme-switcher")||t;window.showTooltip(i,s,0)}}showMobileTooltip(t,e){const i=this.getThemeDescription(e);if(window.showTooltip){const s=t.closest(".theme-switcher")||t;window.showTooltip(i,s,0),setTimeout(()=>{window.hideTooltip&&window.hideTooltip()},2e3)}}hideTooltip(){window.hideTooltip&&window.hideTooltip()}}document.addEventListener("DOMContentLoaded",()=>{window.themeManager=new _e});const S=document.getElementById("soundCanvas"),g=S.getContext("2d"),b=window.devicePixelRatio||1;let D=new Map;const $=new Audio("./assets/5.mp3"),X=[{dirX:0,dirY:-1,audio:new Audio("./assets/2.mp3")},{dirX:0,dirY:1,audio:new Audio("./assets/8.mp3")},{dirX:-1,dirY:0,audio:new Audio("./assets/4.mp3")},{dirX:1,dirY:0,audio:new Audio("./assets/6.mp3")},{dirX:1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/3.mp3")},{dirX:-1/Math.SQRT2,dirY:-1/Math.SQRT2,audio:new Audio("./assets/1.mp3")},{dirX:-1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/7.mp3")},{dirX:1/Math.SQRT2,dirY:1/Math.SQRT2,audio:new Audio("./assets/9.mp3")}];function Xe(){const n=S.clientWidth,t=S.clientHeight;S.width=n*b,S.height=t*b,g.resetTransform(),g.scale(b,b)}function Ye(){Xe();const n=S.clientWidth,t=S.clientHeight,e=n/2,i=t/2,o=Math.min(n,t),s=.4,a=o*.15*s,c=a*.4,r=a+c+o*.12*s;if(g.clearRect(0,0,n,t),g.beginPath(),g.arc(e,i,a,0,Math.PI*2),g.lineWidth=c,D.has(-1)){const{startTime:h,duration:u}=D.get(-1),d=ye(h,u);if(d>0){const m=Math.floor(255*d),w=Math.floor(107*d),p=Math.floor(107*d);g.strokeStyle=`rgb(${m}, ${w}, ${p})`}else{const m=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.strokeStyle=m==="dark"?"#fff":"#000",D.delete(-1)}}else{const h=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.strokeStyle=h==="dark"?"#fff":"#000"}g.stroke(),[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((h,u)=>{for(let d=1;d<=3;d++){const m=e+h.x*r*d,w=i+h.y*r*d,p=u*3+(d-1);if(g.beginPath(),g.arc(m,w,c,0,Math.PI*2),D.has(p)){const{startTime:y,duration:M}=D.get(p),v=ye(y,M);if(v>0){const E=Math.floor(255*v),I=Math.floor(107*v),T=Math.floor(107*v);g.fillStyle=`rgb(${E}, ${I}, ${T})`,g.fill(),g.strokeStyle="#fff",g.lineWidth=2,g.stroke()}else{D.delete(p);const E=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.fillStyle=E==="dark"?"#fff":"#000",g.fill()}}else{const y=window.themeManager?window.themeManager.getEffectiveTheme():"light";g.fillStyle=y==="dark"?"#fff":"#000",g.fill()}}})}let Y=[];const ze=.006,je=.016;S.addEventListener("click",n=>{const t=S.getBoundingClientRect(),e=S.clientWidth,i=S.clientHeight,o=n.clientX-t.left,s=n.clientY-t.top,a=e/2,c=i/2,r=Math.min(e,i),l=.4,h=r*.15*l;if((o-a)**2+(s-c)**2<=h*h){Y.push({x:a,y:c,radius:h,alpha:1}),$.currentTime=0,$.play();return}const u=h*.4,d=h+u+r*.12*l;for(const{dirX:m,dirY:w,audio:p}of X)for(let y=1;y<=3;y++){const M=a+m*d*y,v=c+w*d*y;if((o-M)**2+(s-v)**2<=u*u){p.currentTime=0,p.play();return}}});function Ue(){const t=Math.min(S.clientWidth,S.clientHeight)*ze,i=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"255,255,255":"0,0,0";Y.forEach((o,s)=>{g.beginPath(),g.arc(o.x,o.y,o.radius,0,Math.PI*2),g.strokeStyle=`rgba(${i},${o.alpha})`,g.lineWidth=2,g.stroke(),o.radius+=t,o.alpha-=je,o.alpha<=0&&Y.splice(s,1)})}function Te(){Ye(),Ue(),requestAnimationFrame(Te)}function Je(n,t=500){const e=Date.now();D.set(n,{startTime:e,duration:t})}function Ge(){D.clear()}window.canvasHighlight={highlightCircle:Je,clearAllHighlights:Ge};function ye(n,t){const e=Date.now()-n,i=Math.min(e/t,1),o=4,s=Math.max(0,1-i),a=Math.sin(e*o/100)*.3+.7;return s*a}Te();const ae={ZERO:0,ONE:.25,TWO:.5,THREE:.75},Ve=.01;let se=null;function ve(){return se||(se=new(window.AudioContext||window.webkitAudioContext)),se}function Ee(n){const t=Math.floor(n/3),e=n%3;return{radian:e+1,direction:t,position:e}}function Ke(n){const t=Math.floor(n/3);return X[t]?X[t].audio:null}function Ze(){if(Y&&S){const n=S.clientWidth/2,t=S.clientHeight/2,o=Math.min(S.clientWidth,S.clientHeight)*.15*.4;Y.push({x:n,y:t,radius:o,alpha:1})}}async function V(n,t={}){if(!n||n.length===0){console.warn("No sequence to play");return}const{inModal:e=!1}=t,i=ve();i.state==="suspended"&&await i.resume(),window.canvasHighlight&&window.canvasHighlight.clearAllHighlights(),e&&window.modalHighlight&&window.modalHighlight.clearModalHighlights();const o={0:[],1:[],2:[],3:[]};n.forEach(s=>{const{radian:a}=Ee(s);o[a].push(s)}),Ze(),e&&window.modalHighlight&&window.modalHighlight.createModalRipple(),$&&setTimeout(()=>{$.currentTime=0,$.play().catch(s=>console.warn("Failed to play droplet sound:",s)),window.canvasHighlight&&window.canvasHighlight.highlightCircle(-1,400),e&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(-1,400)},0),Object.keys(o).forEach(s=>{const a=o[s];if(a.length===0)return;const c=parseInt(s),r=ae[Object.keys(ae)[c]]*1e3;a.forEach((l,h)=>{const u=Ke(l);if(u){const d=r+h*Ve*1e3;setTimeout(()=>{u.currentTime=0,u.play().catch(m=>console.warn(`Failed to play audio for circle ${l}:`,m)),window.canvasHighlight&&window.canvasHighlight.highlightCircle(l,600),e&&window.modalHighlight&&window.modalHighlight.highlightModalCircle(l,600)},d)}})})}const K=5;let P=new Map;function xe(n,t){return n||JSON.stringify(t)}function ue(n,t,e=null){const i=xe(e,n);if(P.has(i)){const o=P.get(i);clearInterval(o.timer),P.delete(i),console.log("🔄 Loop playback stopped for thumbnail"),ce(),z()}else{if(P.size>=K){console.warn(`🔄 Maximum number of concurrent loops (${K}) reached. Cannot start new loop.`);const s=document.getElementById("loopCounter");if(s){const a=s.className;s.className=s.className.replace(/bg-\S+/g,"bg-red-200 dark:bg-red-800"),s.style.animation="pulse 0.5s ease-in-out 2",setTimeout(()=>{s.className=a,s.style.animation=""},1e3)}return}console.log(`🔄 Starting loop playback every ${t}s`),V(n);const o=setInterval(async()=>{try{await V(n)}catch(s){console.error("Error in loop playback:",s),ue(n,t,e)}},t*1e3);P.set(i,{timer:o,sequence:n,interval:t,thumbnail:e}),console.log("🔄 Loop playback started"),ce(),z()}}function Le(n,t=null){if(!n)return!1;const e=xe(t,n);return P.has(e)}function z(){const n=document.getElementById("loopCounter");if(!n)return;const t=P.size;t>0?(n.textContent=`Loops playing: ${t}/${K}`,n.classList.remove("hidden")):n.classList.add("hidden")}function ce(){const n=document.getElementById("sequenceBar");if(!n)return;n.querySelectorAll("canvas").forEach(e=>{const i=e.sequenceData;if(i){const o=Le(i.seq,e),s=document.documentElement.classList.contains("dark");e.classList.remove("bg-swarmstripe-200/50","bg-swarmshadow-50","rounded-lg","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),e.style.backgroundColor="",e.style.animation="",o&&(e.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","loop-pulse-animation","p-2"),s?e.classList.add("bg-swarmshadow-50"):e.classList.add("bg-swarmstripe-200/50"),e.style.animation="loop-pulse 2s ease-in-out infinite")}})}function re(){if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",re);return}const n=document.getElementById("sequenceBar");if(!n){console.warn("Sequence bar not found, retrying..."),setTimeout(re,100);return}n.addEventListener("click",async t=>{const e=t.target.closest("canvas");if(!e)return;let i;if(e.sequenceData)i=e.sequenceData;else{const c=Array.from(n.children).indexOf(e);try{i=(await N())[c]}catch(r){console.error("Error loading sequence:",r);return}}if(!i)return;let o,s,a;Array.isArray(i)?(o=i,s=!1,a=3):(o=i.seq||i.sequence,s=i.isLoop||!1,a=i.loopInterval||3);try{s?ue(o,a,e):await V(o)}catch(c){console.error("Error playing sequence:",c)}})}re();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",z):z();window.audioSystem={playSequence:V,initAudioContext:ve,toggleLoopPlayback:ue,isSequenceLooping:Le,updateThumbnailLoopStates:ce,updateLoopCounter:z,getRadianInfo:Ee,RADIAN_TIMING:ae,MAX_CONCURRENT_LOOPS:K,getActiveLoopCount:()=>P.size};const R=document.getElementById("tooltip");function qe(n,t,e=0){const i=t.getBoundingClientRect(),o=window.innerWidth,s=window.innerHeight;R.textContent=n;const a=t.closest("#sequenceModal")!==null;let c,r;if(a||o<640){const l=R.offsetWidth||200;if(a){const u=document.getElementById("modalContent").getBoundingClientRect();c=u.left+(u.width-l)/2,r=u.top-40,r<16&&(r=u.top+8)}else c=(o-l)/2,r=i.bottom+8;c=Math.max(8,Math.min(c,o-l-8)),r=Math.max(8,Math.min(r,s-50))}else{c=i.left+i.width/2-R.offsetWidth/2+e,r=i.bottom+16;const l=R.offsetWidth||200;c=Math.max(8,Math.min(c,o-l-8))}R.style.left=c+"px",R.style.top=r+"px",R.classList.remove("hidden"),R.removeAttribute("aria-hidden")}function be(){R.classList.add("hidden"),R.setAttribute("aria-hidden","true")}window.showTooltip=qe;window.hideTooltip=be;window.showTooltip=qe;window.hideTooltip=be;async function Z(n){const t=document.getElementById("sequenceBar"),e=80,i=document.createElement("canvas");i.width=e*b,i.height=e*b,i.style.width=e+"px",i.style.height=e+"px";const o=i.getContext("2d");o.scale(b,b);let s,a,c;Array.isArray(n)?(s=n,a=!1,c=3):(s=n.sequence||n,a=n.isLoop||!1,c=n.loopInterval||3);const r=3,l=e-r,h=e/2,u=e/2,d=l*.08,m=d*.35,w=d*1.8;o.beginPath(),o.arc(h,u,d,0,2*Math.PI);const y=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";if(o.fillStyle=y,o.fill(),X.forEach(({dirX:M,dirY:v,audio:E},I)=>{for(let T=1;T<=3;T++){const ne=[0,1,2,3,4,5,7,6].indexOf(I)*3+(T-1),Re=s.includes(ne),oe=h+M*w*T,ie=u+v*w*T;if(oe-m>=r&&oe+m<=e-r&&ie-m>=r&&ie+m<=e-r){o.beginPath(),o.arc(oe,ie,m,0,2*Math.PI);const fe=window.themeManager?window.themeManager.getEffectiveTheme():"light",Ae=fe==="dark"?"#fff":"#000",Be=fe==="dark"?"#000":"#fff";o.fillStyle=Ae,o.strokeStyle=Be,o.lineWidth=.5,Re?o.fill():o.stroke()}}}),i.sequenceData={seq:s,isLoop:a,loopInterval:c},window.audioSystem&&window.audioSystem.isSequenceLooping&&window.audioSystem.isSequenceLooping(s,i)){const M=document.documentElement.classList.contains("dark");i.classList.add("rounded-full","transition-colors","duration-300","ease-in-out","p-2"),M?i.classList.add("bg-swarmshadow-50"):i.classList.add("bg-swarmstripe-200/50"),i.style.animation="loop-pulse 2s ease-in-out infinite"}t.appendChild(i)}function pe(){N().then(n=>{n.forEach(t=>Z(t)),console.log(`✅ Loaded ${n.length} saved sequences`)}).catch(n=>{console.error("Failed to load sequences:",n)})}function et(){document.getElementById("sequenceBar").querySelectorAll("canvas").forEach(e=>e.remove()),N().then(e=>{e.forEach(i=>Z(i))}).catch(e=>{console.error("Failed to reload sequences after theme change:",e)})}document.addEventListener("DOMContentLoaded",()=>{if(window.themeManager){const n=window.themeManager.setTheme.bind(window.themeManager);window.themeManager.setTheme=async function(t){await n(t),et()}}});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",pe):pe();class tt{constructor(){this.contextMenu=null,this.currentThumbnail=null,this.init()}init(){this.contextMenu=document.getElementById("contextMenu"),this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",e=>{this.contextMenu.contains(e.target)||this.hideContextMenu()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.hideContextMenu()}),document.getElementById("editSequence").addEventListener("click",()=>{this.editSequence(),this.hideContextMenu()}),document.getElementById("deleteSequence").addEventListener("click",()=>{this.deleteSequence(),this.hideContextMenu()});const t=document.getElementById("sequenceBar");t&&t.addEventListener("contextmenu",e=>{const i=e.target.closest("canvas");i&&i.sequenceData&&(e.preventDefault(),this.showContextMenu(e,i))})}showContextMenu(t,e){this.currentThumbnail=e,this.contextMenu.style.visibility="hidden",this.contextMenu.classList.remove("hidden");const i=this.contextMenu.getBoundingClientRect(),o=i.width,s=i.height,a=window.innerWidth,c=window.innerHeight;let r=t.clientX,l=t.clientY;const h=8;r+o+h>a&&(r=r-o,r<h&&(r=a-o-h)),r=Math.max(h,r),l+s+h>c&&(l=l-s,l<h&&(l=c-s-h)),l=Math.max(h,l);const u=document.getElementById("sequenceBar");if(u){const d=u.getBoundingClientRect();t.clientY>=d.top&&l+s>d.top&&(l=Math.max(h,d.top-s-4))}this.contextMenu.style.left=r+"px",this.contextMenu.style.top=l+"px",this.contextMenu.style.visibility="visible"}hideContextMenu(){this.contextMenu.classList.add("hidden"),this.contextMenu.style.visibility="",this.currentThumbnail=null}editSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const t=this.currentThumbnail.sequenceData;this.currentThumbnail.setAttribute("data-editing","true"),window.modalManager&&window.modalManager.openEditMode(t,this.currentThumbnail)}async deleteSequence(){if(!this.currentThumbnail||!this.currentThumbnail.sequenceData)return;const t=this.currentThumbnail,e=this.currentThumbnail.sequenceData;if(confirm("Are you sure you want to delete this sequence? This action cannot be undone."))try{const s=(await N()).findIndex(a=>{const c=Array.isArray(a)?a:a.sequence||a.seq,r=Array.isArray(e)?e:e.sequence||e.seq;return JSON.stringify(c)===JSON.stringify(r)});if(s!==-1){if(await $e(s),t.remove(),window.audioSystem&&window.audioSystem.isSequenceLooping){const a=Array.isArray(e)?e:e.sequence||e.seq;if(window.audioSystem.isSequenceLooping(a,t)){const c=e.loopInterval||3;window.audioSystem.toggleLoopPlayback(a,c,t)}}console.log("✅ Sequence deleted successfully")}else console.error("❌ Sequence not found in storage"),alert("Sequence not found in storage. It may have already been deleted.")}catch(o){console.error("❌ Failed to delete sequence:",o),alert("Failed to delete sequence. Please try again.")}}}document.addEventListener("DOMContentLoaded",()=>{window.contextMenuManager=new tt});const ee=document.getElementById("createSequenceBtn"),A=document.getElementById("sequenceModal"),x=document.getElementById("sequenceCanvas"),f=x.getContext("2d"),Se=document.getElementById("modalTitle");let B=new Map,j=[];const nt=4,ot=.04;class ke{constructor(){this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,this.init()}init(){this.setupEventListeners()}setupEventListeners(){ee.addEventListener("click",()=>{this.openCreateMode()})}async openCreateMode(){hideTooltip(),ee.classList.remove("highlight-once"),document.body.classList.remove("tutorial-active"),this.isEditMode=!1,this.editingThumbnail=null,this.originalSequenceData=null,Se.textContent="Create New Sequence",k=!await de("tutorialSeen"),k?(G.classList.remove("hidden"),st.textContent=_,Ce.textContent="0"):G.classList.add("hidden"),this.resetModalState(),this.showModal()}openEditMode(t,e){this.isEditMode=!0,this.editingThumbnail=e,this.originalSequenceData=JSON.parse(JSON.stringify(t)),Se.textContent="Edit Sequence",k=!1,G.classList.add("hidden"),this.resetModalState(),this.showModal(),this.loadSequenceIntoModal(t),J(),le()}resetModalState(){q.forEach(e=>{e.clicked=!1}),H.checked=!1,O.value=3,U.style.opacity="0.5",O.disabled=!0,B.clear(),j.length=0;const t=document.getElementById("modalInstruction");t&&t.classList.add("hidden")}loadSequenceIntoModal(t){const e=Array.isArray(t)?t:t.seq||t.sequence||[],i=t.isLoop||!1,o=t.loopInterval||3;H.checked=i,O.value=o,i&&(U.style.opacity="1",O.disabled=!1),e.forEach(s=>{q[s]&&(q[s].clicked=!0)})}showModal(){A.classList.remove("hidden"),A.classList.add("flex"),A.setAttribute("aria-hidden","false"),this.initializeModalCircles(),J(),me(),k&&Ie(),le()}initializeModalCircles(){const t=x.clientWidth,e=x.clientHeight,i=250,o=(t-i)/2,s=(e-i)/2,a=i/2,c=i/2,r=i*.09,l=r*.3,h=r+l*2,u=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}];q=[],u.forEach((d,m)=>{const p=X[[0,1,2,3,4,5,7,6][m]].audio;for(let y=1;y<=3;y++)q.push({x:o+a+d.x*h*y,y:s+c+d.y*h*y,r:l,audio:p,clicked:!1})})}}function it(){const n=x.clientWidth,t=x.clientHeight;x.width=n*b,x.height=t*b,f.resetTransform(),f.scale(b,b)}const C=document.getElementById("testSequenceBtn"),Q=document.getElementById("saveSequenceBtn"),G=document.getElementById("tutorialCounter"),st=document.getElementById("targetCount"),Ce=document.getElementById("selectedCount"),H=document.getElementById("loopToggle"),O=document.getElementById("loopInterval"),U=document.getElementById("loopIntervalControls");let q=[],k=!1;const _=5;async function at(){try{const n=await de("tutorialSeen"),t=await N();!n&&t.length===0&&(document.body.classList.add("tutorial-active"),ee.classList.add("highlight-once"),showTooltip("Start playing by clicking New Sequence!",ee))}catch(n){console.log("Could not check tutorial state:",n)}}setTimeout(at,100);const ct=new ke;window.modalManager=ct;function J(){it();const n=x.clientWidth,t=x.clientHeight,e=Math.min(250,250);f.clearRect(0,0,n,t),f.save();const i=(n-e)/2,o=(t-e)/2;f.translate(i,o);const s=e/2,a=e/2;rt();const c=e*.09;if(f.beginPath(),f.arc(s,a,c,0,2*Math.PI),B.has(-1)){const{startTime:u,duration:d}=B.get(-1),m=Me(u,d);if(m>0){const w=Math.floor(255*m),p=Math.floor(107*m),y=Math.floor(107*m);f.fillStyle=`rgb(${w}, ${p}, ${y})`}else{const w=window.themeManager?window.themeManager.getEffectiveTheme():"light";f.fillStyle=w==="dark"?"#fff":"#000",B.delete(-1)}}else{const u=window.themeManager?window.themeManager.getEffectiveTheme():"light";f.fillStyle=u==="dark"?"#fff":"#000"}f.fill();const r=c*.3,l=c+r*2;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((u,d)=>{var m;for(let w=1;w<=3;w++){const p=s+u.x*l*w,y=a+u.y*l*w,M=d*3+(w-1);f.beginPath(),f.arc(p,y,r,0,2*Math.PI);const v=(m=q[M])==null?void 0:m.clicked;if(B.has(M)){const{startTime:E,duration:I}=B.get(M),T=Me(E,I);if(T>0){const F=Math.floor(255*T),L=Math.floor(107*T),ne=Math.floor(107*T);f.fillStyle=`rgb(${F}, ${L}, ${ne})`,f.fill(),f.strokeStyle="#fff",f.lineWidth=2,f.stroke()}else{B.delete(M);const L=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";v?(f.fillStyle=L,f.fill()):(f.strokeStyle=L,f.lineWidth=2,f.stroke())}}else{const I=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"#fff":"#000";v?(f.fillStyle=I,f.fill()):(f.strokeStyle=I,f.lineWidth=2,f.stroke())}}}),f.restore()}function rt(n,t,e,i){const s=(window.themeManager?window.themeManager.getEffectiveTheme():"light")==="dark"?"255,255,255":"0,0,0";j.forEach((a,c)=>{f.beginPath(),f.arc(a.x,a.y,a.radius,0,Math.PI*2),f.strokeStyle=`rgba(${s},${a.alpha})`,f.lineWidth=2,f.stroke(),a.radius+=nt,a.alpha-=ot,a.alpha<=0&&j.splice(c,1)})}function lt(n,t=600){const e=Date.now();B.set(n,{startTime:e,duration:t})}function dt(){B.clear()}function ht(){j.push({x:125,y:125,radius:22.5,alpha:1})}function me(){A.classList.contains("hidden")||(J(),requestAnimationFrame(me))}window.modalHighlight={highlightModalCircle:lt,clearModalHighlights:dt,createModalRipple:ht,startAnimation:me};x.addEventListener("click",async n=>{const t=x.getBoundingClientRect(),e=n.clientX-t.left,i=n.clientY-t.top,o=x.clientWidth,s=x.clientHeight,a=250,c=(o-a)/2,r=(s-a)/2,l=e-c,h=i-r,u=a/2,d=a/2,m=a*.09,w=m*.3,p=m+w*2;[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0},{x:1/Math.SQRT2,y:-1/Math.SQRT2},{x:-1/Math.SQRT2,y:-1/Math.SQRT2},{x:1/Math.SQRT2,y:1/Math.SQRT2},{x:-1/Math.SQRT2,y:1/Math.SQRT2}].forEach((M,v)=>{for(let E=1;E<=3;E++){const I=u+M.x*p*E,T=d+M.y*p*E,F=v*3+(E-1),L=q[F];if(L&&(l-I)**2+(h-T)**2<=w*w){L.clicked=!L.clicked,L.clicked&&(L.audio.currentTime=0,L.audio.play()),le(),J();return}}})});function le(){const n=q.filter(t=>t.clicked).length;k?(n===_?(C.disabled=!1,C.classList.add("highlight-once"),showTooltip("Click Test to hear what your sequence sounds like!",C)):(C.disabled=!0,C.classList.remove("highlight-once")),Ie()):n>0?(C.disabled=!1,Q.disabled=!1):(C.disabled=!0,Q.disabled=!0)}function Ie(){if(!k)return;const n=q.filter(e=>e.clicked).length;Ce.textContent=n;const t=document.getElementById("modalInstruction");if(n===0)t.textContent="Click the empty circles to form your sequence",t.classList.remove("hidden"),hideTooltip();else if(n<_){const e=_-n;t.textContent=`Select ${e} more circle${e===1?"":"s"}`,t.classList.remove("hidden"),hideTooltip()}else n===_&&(t.classList.add("hidden"),hideTooltip())}C.addEventListener("click",async n=>{hideTooltip(),C.classList.remove("highlight-once");const t=q.map((e,i)=>e.clicked?i:null).filter(e=>e!==null);if(t.length>0)try{window.audioSystem&&window.audioSystem.playSequence?await window.audioSystem.playSequence(t,{inModal:!0}):console.warn("Audio system not available, falling back to basic feedback"),k&&(Q.disabled=!1),k&&(await he("tutorialSeen",!0),k=!1)}catch(e){console.error("Error playing test sequence:",e),k&&(Q.disabled=!1)}});H.addEventListener("change",()=>{const n=H.checked;O.disabled=!n,n?U.classList.remove("opacity-50"):U.classList.add("opacity-50")});Q.addEventListener("click",async()=>{const n=q.map((o,s)=>o.clicked?s:null).filter(o=>o!==null),t=H.checked,e=parseInt(O.value)||3,i={sequence:n,isLoop:t,loopInterval:e};try{if(window.modalManager.isEditMode){const o=await N(),s=Array.isArray(window.modalManager.originalSequenceData)?window.modalManager.originalSequenceData:window.modalManager.originalSequenceData.sequence||window.modalManager.originalSequenceData.seq,a=o.findIndex(c=>{const r=Array.isArray(c)?c:c.sequence||c.seq;return JSON.stringify(r)===JSON.stringify(s)});if(a!==-1){if(await Fe(a,i),window.audioSystem&&window.audioSystem.isSequenceLooping&&window.audioSystem.isSequenceLooping(s,window.modalManager.editingThumbnail)){const c=window.modalManager.originalSequenceData.loopInterval||3;window.audioSystem.toggleLoopPlayback(s,c,window.modalManager.editingThumbnail)}window.modalManager.editingThumbnail.removeAttribute("data-editing"),window.modalManager.editingThumbnail.remove(),Z(i),console.log("✅ Sequence updated successfully")}else throw new Error("Original sequence not found in storage")}else await We(i),Z(i),console.log("✅ New sequence saved successfully");k&&await he("tutorialSeen",!0),te()}catch(o){console.error("❌ Failed to save sequence:",o),alert("Failed to save sequence. Please try again.")}});function te(){hideTooltip(),A.classList.add("hidden"),A.classList.remove("flex"),A.setAttribute("aria-hidden","true"),window.modalManager.isEditMode&&window.modalManager.editingThumbnail&&window.modalManager.editingThumbnail.removeAttribute("data-editing"),window.modalManager.isEditMode=!1,window.modalManager.editingThumbnail=null,window.modalManager.originalSequenceData=null,q.forEach(t=>t.clicked=!1),C.disabled=!0,C.classList.remove("highlight-once"),Q.disabled=!0,G.classList.add("hidden"),k=!1;const n=document.getElementById("modalInstruction");n&&n.classList.add("hidden"),H.checked=!1,O.value=3,O.disabled=!0,U.style.opacity="0.5",window.modalHighlight&&window.modalHighlight.clearModalHighlights(),j.length=0,J()}const ut=document.getElementById("closeModalBtn");ut.addEventListener("click",te);A.addEventListener("click",n=>{n.target===A&&te()});const mt=document.getElementById("modalContent");mt.addEventListener("click",n=>{n.stopPropagation()});document.addEventListener("keydown",n=>{n.key==="Escape"&&!A.classList.contains("hidden")&&te()});function Me(n,t){const e=Date.now()-n,i=Math.min(e/t,1),o=4,s=Math.max(0,1-i),a=Math.sin(e*o/100)*.3+.7;return s*a}window.modalManager=new ke;(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.protocol==="file:")&&Oe(()=>import("./dev-tools-DXIln_vP.js"),[]).catch(n=>{console.log("Dev tools not loaded (production build)")});console.log("🎵 Click Ripple app initialized");export{W as o,he as s};
