<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Sequence - Create Custom Sound Patterns</title>
  <meta name="description" content="Create and save custom sound sequences using clicking sounds and glossolalia">

  <!-- SEO Meta Tags -->
  <meta name="keywords" content="custom sound sequences, clicking patterns, glossolalia creation, sound maker, audio sequences, vocal patterns">
  <meta name="author" content="Click Sound Rippler Project">
  <meta name="robots" content="index, follow">
  <meta name="language" content="en">

  <!-- Open Graph Meta Tags for Social Sharing -->
  <meta property="og:title" content="New Sequence - Create Custom Sound Patterns">
  <meta property="og:description" content="Create and save custom sound sequences using clicking sounds and glossolalia">
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:site_name" content="Click Sound Rippler">
  <meta property="og:locale" content="en_US">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="New Sequence - Create Custom Sound Patterns">
  <meta name="twitter:description" content="Create and save custom sound sequences using clicking sounds and glossolalia">

  <!-- Favicon and Icons -->
  <!-- <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest"> -->

  <!-- Theme Color -->
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-TileColor" content="#000000">

  <!-- Canonical URL -->
  <link rel="canonical" href="">

  <link rel="stylesheet" href="css/colors.css">
  <link rel="stylesheet" href="css/colors-darkmode.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/bottom_bar.css">
  <link rel="stylesheet" href="css/tooltip.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="css/tutorial.css">
  <link rel="stylesheet" href="css/accessibility.css">
  <style>
    /* Theme Toggle Button */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border: 2px solid var(--color-primary);
      background-color: var(--color-surface);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .theme-toggle:hover {
      background-color: var(--color-accent);
      transform: scale(1.05);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: var(--color-background);
      flex-direction: column;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7, auto);
      grid-template-rows: repeat(7, auto);
      gap: 0px;
      margin-top: 100px;
    }

    .grid div .sound-button,
    .grid div button,
    .sound-button {
      /* Reset button defaults */
      padding: 0;
      margin: 0;
      border: 2px solid var(--color-primary);
      outline: none;
      background-color: var(--color-background);
      font-family: inherit;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      /* Our custom styles */
      width: 36px;
      height: 36px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      user-select: none;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.3s;
      color: var(--color-text);
    }

    .grid div button:hover,
    .grid div button:focus {
      background-color: var(--color-accent);
    }

    .grid div button.clicked {
      background-color: var(--color-primary);
      color: var(--color-text-light);
    }

    .grid div[data-layer="2"],
    .grid div[data-layer="3"] {
      position: relative;
    }

    .grid div[data-layer="2"] button,
    .grid div[data-layer="3"] button {
      position: absolute;
    }

    .grid div[data-layer="1"][data-audio="1"] button {
      margin: 30px 0px 0px 30px;
    }

    .grid div[data-layer="1"][data-audio="2"] button {
      margin: 0px 30px 30px 30px;
    }

    .grid div[data-layer="1"][data-audio="3"] button {
      margin: 30px 30px 0px 0px;
    }

    .grid div[data-layer="1"][data-audio="4"] button {
      margin: 30px 30px 30px 0px;
    }

    .grid div[data-layer="1"][data-audio="6"] button {
      margin: 30px 0px 30px 30px;
    }

    .grid div[data-layer="1"][data-audio="7"] button {
      margin: 0px 0px 30px 30px;
    }

    .grid div[data-layer="1"][data-audio="8"] button {
      margin: 30px 30px 0px 30px;
    }

    .grid div[data-layer="1"][data-audio="9"] button {
      margin: 0px 30px 30px 0px;
    }

    .grid div[data-layer="2"][data-audio="1"] button {
      bottom: -15px;
      right: -15px;
    }

    .grid div[data-layer="2"][data-audio="2"] button {
      left: 30px;
      bottom: 30px;
    }

    .grid div[data-layer="2"][data-audio="3"] button {
      left: -15px;
      bottom: -15px;
    }

    .grid div[data-layer="2"][data-audio="4"] button {
      top: 30px;
      right: 30px;
    }

    .grid div[data-layer="2"][data-audio="6"] button {
      top: 30px;
      left: 30px;
    }

    .grid div[data-layer="2"][data-audio="7"] button {
      top: -15px;
      right: -15px;
    }

    .grid div[data-layer="2"][data-audio="8"] button {
      top: 30px;
      left: 30px;
    }

    .grid div[data-layer="2"][data-audio="9"] button {
      top: -15px;
      left: -15px;
    }

    .grid div[data-layer="3"][data-audio="1"] button {
      bottom: 45px;
      right: 45px;
    }

    .grid div[data-layer="3"][data-audio="2"] button {
      left: 30px;
      bottom: 105px;
    }

    .grid div[data-layer="3"][data-audio="3"] button {
      left: 45px;
      bottom: 45px;
    }

    .grid div[data-layer="3"][data-audio="4"] button {
      top: 30px;
      right: 105px;
    }

    .grid div[data-layer="3"][data-audio="6"] button {
      top: 30px;
      left: 105px;
    }

    .grid div[data-layer="3"][data-audio="7"] button {
      top: 45px;
      right: 45px;
    }

    .grid div[data-layer="3"][data-audio="8"] button {
      top: 105px;
      left: 30px;
    }

    .grid div[data-layer="3"][data-audio="9"] button {
      top: 45px;
      left: 45px;
    }

    .grid .droplet,
    button.droplet {
      /* Reset button defaults */
      padding: 0;
      margin: 0;
      outline: none;
      font-family: inherit;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      /* Droplet styles */
      height: 60px;
      width: 60px;
      border: 20px solid var(--color-primary);
      background-color: var(--color-background);
      display: flex;
      position: relative;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .droplet:hover,
    button.droplet:hover {
      background-color: var(--color-surface);
    }

    .grid div[data-audio="0"] {
      z-index: -100;
      opacity: 0;
    }

    .grid div.clicked {
      background-color: var(--color-primary);
    }

    .save-button {
      cursor: pointer;
      margin-top: 220px;
      width: auto;
      padding: 10px 20px;
      background: var(--color-accent);
      text-decoration: none;
      font-weight: 200;
      font-size: 17px;
      color: white;
      border: none;
      border-radius: 10px;
      transition: background-color 0.2s;
    }

    .save-button:hover {
      background: var(--color-accent-dark);
    }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      width: 100%;
      padding: 8px 16px;
      background: var(--color-primary);
      color: white;
      text-align: center;
      text-decoration: none;
      border-radius: 4px;
      transition: top 0.3s;
      z-index: 1000;
    }

    .skip-link:focus {
      top: 20px;
    }

    /* Visually Hidden Class */
    .visually-hidden,
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <!-- Skip Link -->
  <a href="#mainContent" class="skip-link" id="skipLink">Skip to main content</a>

  <!-- Theme Toggle Button -->
  <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()"
          aria-label="Toggle between light and dark theme"
          title="Toggle theme">
    <span class="toggle-icon" aria-hidden="true">🔄</span>
  </button>

  <main id="mainContent">
    <h1 class="visually-hidden">Create New Sound Sequence</h1>

  <div class="grid" id="grid" role="grid" aria-label="Sound sequence grid">
    <div data-row="0" data-col="0" data-layer="3" data-audio="1" role="gridcell"><button class="sound-button" tabindex="0" aria-label="Sound button 1 - Layer 3"></button></div>
    <div data-row="0" data-col="1" data-layer="3" data-audio="0" role="gridcell"><button class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button></div>
    <div data-row="0" data-col="2" data-layer="3" data-audio="0" role="gridcell"><button class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button></div>
    <div data-row="0" data-col="3" data-layer="3" data-audio="2" role="gridcell"><button class="sound-button" tabindex="0" aria-label="Sound button 2 - Layer 3"></button></div>
    <div data-row="0" data-col="4" data-layer="3" data-audio="0" role="gridcell"><button class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button></div>
    <div data-row="0" data-col="5" data-layer="3" data-audio="0" role="gridcell"><button class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button></div>
    <div data-row="0" data-col="6" data-layer="3" data-audio="3" role="gridcell"><button class="sound-button" tabindex="0" aria-label="Sound button 3 - Layer 3"></button></div>
    <div data-row="1" data-col="0" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 8"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="1" data-col="1" data-layer="2" data-audio="1" role="gridcell" aria-label="Sound button 9"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="1" data-col="2" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 10"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="1" data-col="3" data-layer="2" data-audio="2" role="gridcell" aria-label="Sound button 11"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="1" data-col="4" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 12"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="1" data-col="5" data-layer="2" data-audio="3" role="gridcell" aria-label="Sound button 13"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="1" data-col="6" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 14"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="2" data-col="0" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 15"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="2" data-col="1" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 16"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="2" data-col="2" data-layer="1" data-audio="1" role="gridcell" aria-label="Sound button 17"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="2" data-col="3" data-layer="1" data-audio="2" role="gridcell" aria-label="Sound button 18"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="2" data-col="4" data-layer="1" data-audio="3" role="gridcell" aria-label="Sound button 19"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="2" data-col="5" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 20"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="2" data-col="6" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 21"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="3" data-col="0" data-layer="3" data-audio="4" role="gridcell" aria-label="Sound button 22"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="3" data-col="1" data-layer="2" data-audio="4" role="gridcell" aria-label="Sound button 23"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="3" data-col="2" data-layer="1" data-audio="4" role="gridcell" aria-label="Sound button 24"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="3" data-col="3" data-layer="0" data-audio="5" role="gridcell">
      <button class="droplet clickableCircle" id="clickableCircle" aria-label="Central droplet sound - Layer 0" tabindex="0"></button>
    </div>
    <div data-row="3" data-col="4" data-layer="1" data-audio="6" role="gridcell" aria-label="Sound button 26"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="3" data-col="5" data-layer="2" data-audio="6" role="gridcell" aria-label="Sound button 27"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="3" data-col="6" data-layer="3" data-audio="6" role="gridcell" aria-label="Sound button 28"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="4" data-col="0" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 29"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="4" data-col="1" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 30"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="4" data-col="2" data-layer="1" data-audio="7" role="gridcell" aria-label="Sound button 31"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="4" data-col="3" data-layer="1" data-audio="8" role="gridcell" aria-label="Sound button 32"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="4" data-col="4" data-layer="1" data-audio="9" role="gridcell" aria-label="Sound button 33"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="4" data-col="5" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 34"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="4" data-col="6" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 35"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="5" data-col="0" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 36"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="5" data-col="1" data-layer="2" data-audio="7" role="gridcell" aria-label="Sound button 37"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="5" data-col="2" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 38"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="5" data-col="3" data-layer="2" data-audio="8" role="gridcell" aria-label="Sound button 39"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="5" data-col="4" data-layer="2" data-audio="0" role="gridcell" aria-label="Sound button 40"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="5" data-col="5" data-layer="2" data-audio="9" role="gridcell" aria-label="Sound button 41"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="5" data-col="6" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 42"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="6" data-col="0" data-layer="3" data-audio="7" role="gridcell" aria-label="Sound button 43"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="6" data-col="1" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 44"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="6" data-col="2" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 45"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="6" data-col="3" data-layer="3" data-audio="8" role="gridcell" aria-label="Sound button 46"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="6" data-col="4" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 47"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="6" data-col="5" data-layer="3" data-audio="0" role="gridcell" aria-label="Sound button 48"><button class="sound-button" tabindex="0"></button></div>
    <div data-row="6" data-col="6" data-layer="3" data-audio="9" role="gridcell" aria-label="Sound button 49"><button class="sound-button" tabindex="0"></button></div>
  </div>
  <button class="save-button" id="save" aria-label="Save your sequence">Save Sequence</button>
  </main>

  <!-- Screen reader announcements -->
  <div id="announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>  <script>    // Persistent Storage using IndexedDB
    class PersistentStorage {
      constructor() {
        this.dbName = 'ClickingGlossaliaDB';
        this.dbVersion = 2;
        this.preferencesStore = 'preferences';
        this.sequencesStore = 'sequences';
        this.db = null;
      }

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.dbVersion);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.db = request.result;
            resolve(this.db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            if (!db.objectStoreNames.contains(this.preferencesStore)) {
              const preferencesStore = db.createObjectStore(this.preferencesStore, { keyPath: 'key' });
            }

            if (!db.objectStoreNames.contains(this.sequencesStore)) {
              const sequencesStore = db.createObjectStore(this.sequencesStore, { keyPath: 'id', autoIncrement: true });
              sequencesStore.createIndex('timestamp', 'timestamp', { unique: false });
            }
          };
        });
      }

      async setTheme(theme) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'themePreference', value: theme });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getTheme() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('themePreference');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : 'system');
          };
        });
      }

      async migrateFromLocalStorage() {
        try {
          const themePreference = localStorage.getItem('themePreference');
          if (themePreference) {
            await this.setTheme(themePreference);
            localStorage.removeItem('themePreference');
          }
        } catch (error) {
          console.warn('Migration from localStorage failed:', error);
        }
      }

      // Tutorial methods
      async setTutorialStatus(completed) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'tutorialCompleted', value: completed });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getTutorialStatus() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('tutorialCompleted');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : false);
          };
        });
      }

      async setDontShowStatus(dontShow) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'tutorialDontShow', value: dontShow });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getDontShowStatus() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('tutorialDontShow');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : false);
          };
        });
      }

      // Tutorial step persistence methods
      async setTutorialStep(step) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'tutorialCurrentStep', value: step });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getTutorialStep() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('tutorialCurrentStep');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : 0);
          };
        });
      }

      async clearTutorialStep() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.delete('tutorialCurrentStep');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }
    }

    // Create global storage instance
    const storage = new PersistentStorage();

    // Theme Toggle Functionality (dark | system | light)
    async function initializeTheme() {
      try {
        await storage.init();
        await storage.migrateFromLocalStorage();
        const savedTheme = await storage.getTheme();
        applyTheme(savedTheme);
      } catch (error) {
        console.warn('Failed to load theme from IndexedDB, falling back to system:', error);
        const fallbackTheme = localStorage.getItem('themePreference') || 'system';
        applyTheme(fallbackTheme);
      }
    }

    function applyTheme(theme) {
      const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

      document.body.classList.remove('dark-mode', 'light-mode');

      switch(theme) {
        case 'dark':
          document.body.classList.add('dark-mode');
          break;
        case 'light':
          document.body.classList.add('light-mode');
          break;
        case 'system':
        default:
          if (prefersDarkMode) {
            document.body.classList.add('dark-mode');
          } else {
            document.body.classList.add('light-mode');
          }
          break;
      }

      updateToggleIcon(theme);
    }    async function toggleTheme() {
      try {
        const currentTheme = await storage.getTheme();
        let nextTheme;

        switch(currentTheme) {
          case 'system':
            nextTheme = 'light';
            break;
          case 'light':
            nextTheme = 'dark';
            break;
          case 'dark':
            nextTheme = 'system';
            break;
          default:
            nextTheme = 'system';
        }

        await storage.setTheme(nextTheme);
        localStorage.setItem('themePreference', nextTheme);

        applyTheme(nextTheme);
      } catch (error) {
        console.warn('Failed to save theme to IndexedDB:', error);
        // Fallback to localStorage-only operation
        const currentTheme = localStorage.getItem('themePreference') || 'system';
        let nextTheme;

        switch(currentTheme) {
          case 'system':
            nextTheme = 'light';
            break;
          case 'light':
            nextTheme = 'dark';
            break;
          case 'dark':
            nextTheme = 'system';
            break;
          default:
            nextTheme = 'system';
        }

        localStorage.setItem('themePreference', nextTheme);
        applyTheme(nextTheme);
      }
    }

    function updateToggleIcon(theme) {
      const toggleButton = document.getElementById('themeToggle');
      if (toggleButton) {
        const toggleIcon = toggleButton.querySelector('.toggle-icon');
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

        switch(theme) {
          case 'dark':
            toggleIcon.textContent = '☀️';
            toggleButton.title = 'Switch to system theme';
            break;
          case 'light':
            toggleIcon.textContent = '🌙';
            toggleButton.title = 'Switch to dark theme';
            break;
          case 'system':
          default:
            toggleIcon.textContent = '🔄';
            toggleButton.title = 'Switch to light theme';
            break;
        }
      }
    }

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeTheme();
    });

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', async (e) => {
      try {
        const currentTheme = await storage.getTheme();
        if (currentTheme === 'system') {
          applyTheme('system');
        }
      } catch (error) {
        const currentTheme = localStorage.getItem('themePreference') || 'system';
        if (currentTheme === 'system') {
          applyTheme('system');
        }
      }
    });

    // Focus management for skip link
    document.getElementById('skipLink').addEventListener('focus', (e) => {
      e.preventDefault();
      document.getElementById('mainContent').focus();
    });
  </script>

  <script src="./js/accessibility.js"></script>
  <script src="./js/new_word.js"></script>
  <script src="./js/tutorial.js"></script>
</body>
</html>
