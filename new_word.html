<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Sequence - Create Custom Sound Patterns</title>
  <meta name="description" content="Create and save custom sound sequences using clicking sounds and glossolalia">

  <!-- SEO Meta Tags -->
  <meta name="keywords" content="clicking sounds, glossolalia, interactive sound grid, tongue clicking, vocal sounds, audio art, mouth sounds">
  <meta name="author" content="Click Sound Rippler Project">
  <meta name="robots" content="index, follow">
  <meta name="language" content="en">

  <!-- Open Graph Meta Tags for Social Sharing -->
  <meta property="og:title" content="Click Ripple - Interactive Sound Grid">
  <meta property="og:description" content="Interactive sound grid for creating and learning clicking sounds and glossolalia">
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:site_name" content="Click Sound Rippler">
  <meta property="og:locale" content="en_US">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Click Ripple - Interactive Sound Grid">
  <meta name="twitter:description" content="Interactive sound grid for creating and learning clicking sounds and glossolalia">

  <!-- Favicon and Icons -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Theme Color -->
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-TileColor" content="#000000">

  <!-- Preload Audio Files -->
  <link rel="preload" href="audio/1.mp3" as="audio">
  <link rel="preload" href="audio/2.mp3" as="audio">
  <link rel="preload" href="audio/3.mp3" as="audio">

  <!-- Canonical URL -->
  <link rel="canonical" href="">

  <link rel="stylesheet" href="css/colors.css">
  <link rel="stylesheet" href="css/colors-darkmode.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/bottom_bar.css">
  <link rel="stylesheet" href="css/tooltip.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="css/tutorial.css">
  <link rel="stylesheet" href="css/accessibility.css">
  <link rel="stylesheet" href="css/new_word.css">
</head>
<body>
  <!-- Skip Link -->
  <a href="#main-content" class="skip-link" id="skipLink">Skip to main content</a>

  <!-- Theme Toggle Button -->
  <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()"
          aria-label="Toggle between light and dark theme"
          title="Toggle theme">
    <span class="toggle-icon" aria-hidden="true">🔄</span>
  </button>

  <main id="main-content">
    <div class="grid" id="grid" role="grid" aria-label="Sound sequence grid">
      <div data-row="0" data-col="0" data-layer="3">
        <button data-audio="1" class="sound-button" tabindex="0" aria-label="Sound button 1 - Layer 3"></button>
      </div>
      <div data-row="0" data-col="1" data-layer="3">
        <button data-audio="0" class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button>
      </div>
      <div data-row="0" data-col="2" data-layer="3">
        <button data-audio="0" class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button>
      </div>
      <div data-row="0" data-col="3" data-layer="3">
        <button data-audio="2" class="sound-button" tabindex="0" aria-label="Sound button 2 - Layer 3"></button>
      </div>
      <div data-row="0" data-col="4" data-layer="3">
        <button data-audio="0" class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button>
      </div>
      <div data-row="0" data-col="5" data-layer="3">
        <button data-audio="0" class="sound-button empty" tabindex="0" aria-label="Empty sound slot"></button>
      </div>
      <div data-row="0" data-col="6" data-layer="3">
        <button data-audio="3" class="sound-button" tabindex="0" aria-label="Sound button 3 - Layer 3"></button>
      </div>
      <div data-row="1" data-col="0" data-layer="3" aria-label="Sound button 8">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="1" data-col="1" data-layer="2" aria-label="Sound button 9">
        <button data-audio="1" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="1" data-col="2" data-layer="2" aria-label="Sound button 10">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="1" data-col="3" data-layer="2" aria-label="Sound button 11">
        <button data-audio="2" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="1" data-col="4" data-layer="2" aria-label="Sound button 12">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="1" data-col="5" data-layer="2" aria-label="Sound button 13">
        <button data-audio="3" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="1" data-col="6" data-layer="3" aria-label="Sound button 14">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="2" data-col="0" data-layer="3" aria-label="Sound button 15">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="2" data-col="1" data-layer="2" aria-label="Sound button 16">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="2" data-col="2" data-layer="1" aria-label="Sound button 17">
        <button data-audio="1" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="2" data-col="3" data-layer="1" aria-label="Sound button 18">
        <button data-audio="2" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="2" data-col="4" data-layer="1" aria-label="Sound button 19">
        <button data-audio="3" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="2" data-col="5" data-layer="2" aria-label="Sound button 20">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="2" data-col="6" data-layer="3" aria-label="Sound button 21">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="3" data-col="0" data-layer="3" aria-label="Sound button 22">
        <button data-audio="4" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="3" data-col="1" data-layer="2" aria-label="Sound button 23">
        <button data-audio="4" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="3" data-col="2" data-layer="1" aria-label="Sound button 24">
        <button data-audio="4" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="3" data-col="3">
        <button class="droplet clickableCircle" id="clickableCircle" aria-label="Central droplet sound - Layer 0" tabindex="0"></button>
      </div>
      <div data-row="3" data-col="4" data-layer="1" aria-label="Sound button 26">
        <button data-audio="5" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="3" data-col="5" data-layer="2" aria-label="Sound button 27">
        <button data-audio="6" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="3" data-col="6" data-layer="3" aria-label="Sound button 28">
        <button data-audio="6" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="4" data-col="0" data-layer="3" aria-label="Sound button 29">
        <button data-audio="6" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="4" data-col="1" data-layer="2" aria-label="Sound button 30">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="4" data-col="2" data-layer="1" aria-label="Sound button 31">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="4" data-col="3" data-layer="1" aria-label="Sound button 32">
        <button data-audio="7" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="4" data-col="4" data-layer="1" aria-label="Sound button 33">
        <button data-audio="8" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="4" data-col="5" data-layer="2" aria-label="Sound button 34">
        <button data-audio="9" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="4" data-col="6" data-layer="3" aria-label="Sound button 35">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="5" data-col="0" data-layer="3" aria-label="Sound button 36">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="5" data-col="1" data-layer="2" aria-label="Sound button 37">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="5" data-col="2" data-layer="2" aria-label="Sound button 38">
        <button data-audio="7" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="5" data-col="3" data-layer="2" aria-label="Sound button 39">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="5" data-col="4" data-layer="2" aria-label="Sound button 40">
        <button data-audio="8" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="5" data-col="5" data-layer="2" aria-label="Sound button 41">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="5" data-col="6" data-layer="3" aria-label="Sound button 42">
        <button data-audio="9" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="6" data-col="0" data-layer="3" aria-label="Sound button 43">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="6" data-col="1" data-layer="3" aria-label="Sound button 44">
        <button data-audio="7" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="6" data-col="2" data-layer="3" aria-label="Sound button 45">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="6" data-col="3" data-layer="3" aria-label="Sound button 46">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
      <div data-row="6" data-col="4" data-layer="3" aria-label="Sound button 47">
        <button data-audio="8" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="6" data-col="5" data-layer="3" aria-label="Sound button 48">
        <button data-audio="0" class="sound-button empty" tabindex="0"></button>
      </div>
      <div data-row="6" data-col="6" data-layer="3" aria-label="Sound button 49">
        <button data-audio="0" class="sound-button" tabindex="0"></button>
      </div>
    </div>
    <button class="primary-button" id="save" aria-label="Save your sequence">Save Sequence</button>
  </main>

  <!-- Screen reader announcements -->
  <div id="announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <script>    // Persistent Storage using IndexedDB
    class PersistentStorage {
      constructor() {
        this.dbName = 'ClickingGlossaliaDB';
        this.dbVersion = 2;
        this.preferencesStore = 'preferences';
        this.sequencesStore = 'sequences';
        this.db = null;
      }

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.dbVersion);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.db = request.result;
            resolve(this.db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            if (!db.objectStoreNames.contains(this.preferencesStore)) {
              const preferencesStore = db.createObjectStore(this.preferencesStore, { keyPath: 'key' });
            }

            if (!db.objectStoreNames.contains(this.sequencesStore)) {
              const sequencesStore = db.createObjectStore(this.sequencesStore, { keyPath: 'id', autoIncrement: true });
              sequencesStore.createIndex('timestamp', 'timestamp', { unique: false });
            }
          };
        });
      }

      async setTheme(theme) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'themePreference', value: theme });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getTheme() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('themePreference');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : 'system');
          };
        });
      }

      async migrateFromLocalStorage() {
        try {
          const themePreference = localStorage.getItem('themePreference');
          if (themePreference) {
            await this.setTheme(themePreference);
            localStorage.removeItem('themePreference');
          }
        } catch (error) {
          console.warn('Migration from localStorage failed:', error);
        }
      }

      // Tutorial methods
      async setTutorialStatus(completed) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'tutorialCompleted', value: completed });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getTutorialStatus() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('tutorialCompleted');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : false);
          };
        });
      }

      async setDontShowStatus(dontShow) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'tutorialDontShow', value: dontShow });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getDontShowStatus() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('tutorialDontShow');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : false);
          };
        });
      }

      // Tutorial step persistence methods
      async setTutorialStep(step) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.put({ key: 'tutorialCurrentStep', value: step });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getTutorialStep() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readonly');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.get('tutorialCurrentStep');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : 0);
          };
        });
      }

      async clearTutorialStep() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.preferencesStore], 'readwrite');
          const store = transaction.objectStore(this.preferencesStore);
          const request = store.delete('tutorialCurrentStep');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }
    }

    // Create global storage instance
    const storage = new PersistentStorage();

    // Theme Toggle Functionality (dark | system | light)
    async function initializeTheme() {
      try {
        await storage.init();
        await storage.migrateFromLocalStorage();
        const savedTheme = await storage.getTheme();
        applyTheme(savedTheme);
      } catch (error) {
        console.warn('Failed to load theme from IndexedDB, falling back to system:', error);
        const fallbackTheme = localStorage.getItem('themePreference') || 'system';
        applyTheme(fallbackTheme);
      }
    }

    function applyTheme(theme) {
      const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

      document.body.classList.remove('dark-mode', 'light-mode');

      switch(theme) {
        case 'dark':
          document.body.classList.add('dark-mode');
          break;
        case 'light':
          document.body.classList.add('light-mode');
          break;
        case 'system':
        default:
          if (prefersDarkMode) {
            document.body.classList.add('dark-mode');
          } else {
            document.body.classList.add('light-mode');
          }
          break;
      }

      updateToggleIcon(theme);
    }    async function toggleTheme() {
      try {
        const currentTheme = await storage.getTheme();
        let nextTheme;

        switch(currentTheme) {
          case 'system':
            nextTheme = 'light';
            break;
          case 'light':
            nextTheme = 'dark';
            break;
          case 'dark':
            nextTheme = 'system';
            break;
          default:
            nextTheme = 'system';
        }

        await storage.setTheme(nextTheme);
        localStorage.setItem('themePreference', nextTheme);

        applyTheme(nextTheme);
      } catch (error) {
        console.warn('Failed to save theme to IndexedDB:', error);
        // Fallback to localStorage-only operation
        const currentTheme = localStorage.getItem('themePreference') || 'system';
        let nextTheme;

        switch(currentTheme) {
          case 'system':
            nextTheme = 'light';
            break;
          case 'light':
            nextTheme = 'dark';
            break;
          case 'dark':
            nextTheme = 'system';
            break;
          default:
            nextTheme = 'system';
        }

        localStorage.setItem('themePreference', nextTheme);
        applyTheme(nextTheme);
      }
    }

    function updateToggleIcon(theme) {
      const toggleButton = document.getElementById('themeToggle');
      if (toggleButton) {
        const toggleIcon = toggleButton.querySelector('.toggle-icon');
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

        switch(theme) {
          case 'dark':
            toggleIcon.textContent = '☀️';
            toggleButton.title = 'Switch to system theme';
            break;
          case 'light':
            toggleIcon.textContent = '🌙';
            toggleButton.title = 'Switch to dark theme';
            break;
          case 'system':
          default:
            toggleIcon.textContent = '🔄';
            toggleButton.title = 'Switch to light theme';
            break;
        }
      }
    }

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeTheme();
    });

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', async (e) => {
      try {
        const currentTheme = await storage.getTheme();
        if (currentTheme === 'system') {
          applyTheme('system');
        }
      } catch (error) {
        const currentTheme = localStorage.getItem('themePreference') || 'system';
        if (currentTheme === 'system') {
          applyTheme('system');
        }
      }
    });

    // Focus management for skip link
    document.getElementById('skipLink').addEventListener('focus', (e) => {
      e.preventDefault();
      document.getElementById('main-content').focus();
    });
  </script>

  <script src="./js/accessibility.js"></script>
  <script src="./js/new_word.js"></script>
  <script src="./js/tutorial.js"></script>
</body>
</html>
