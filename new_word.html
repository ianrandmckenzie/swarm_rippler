<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Sequence</title>
  <link rel="stylesheet" href="css/colors.css">
  <link rel="stylesheet" href="css/colors-darkmode.css">
  <style>
    /* Theme Toggle Button */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border: 2px solid var(--color-primary);
      background-color: var(--color-surface);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .theme-toggle:hover {
      background-color: var(--color-accent);
      transform: scale(1.05);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: var(--color-background);
      flex-direction: column;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7, auto);
      grid-template-rows: repeat(7, auto);
      gap: 0px;
      margin-top: 100px;
    }

    .grid div div {
      width: 36px;
      height: 36px;
      border: 2px solid var(--color-primary);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      user-select: none;
      background-color: var(--color-background);
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .grid div[data-layer="2"],
    .grid div[data-layer="3"] {
      position: relative;
    }

    .grid div[data-layer="2"] div,
    .grid div[data-layer="3"] div {
      position: absolute;
    }

    .grid div[data-layer="1"][data-audio="1"] div {
      margin: 30px 0px 0px 30px;
    }

    .grid div[data-layer="1"][data-audio="2"] div {
      margin: 0px 30px 30px 30px;
    }

    .grid div[data-layer="1"][data-audio="3"] div {
      margin: 30px 30px 0px 0px;
    }

    .grid div[data-layer="1"][data-audio="4"] div {
      margin: 30px 30px 30px 0px;
    }

    .grid div[data-layer="1"][data-audio="6"] div {
      margin: 30px 0px 30px 30px;
    }

    .grid div[data-layer="1"][data-audio="7"] div {
      margin: 0px 0px 30px 30px;
    }

    .grid div[data-layer="1"][data-audio="8"] div {
      margin: 30px 30px 0px 30px;
    }

    .grid div[data-layer="1"][data-audio="9"] div {
      margin: 0px 30px 30px 0px;
    }

    .grid div[data-layer="2"][data-audio="1"] div {
      bottom: -15px;
      right: -15px;
    }

    .grid div[data-layer="2"][data-audio="2"] div {
      left: 30px;
      bottom: 30px;
    }

    .grid div[data-layer="2"][data-audio="3"] div {
      left: -15px;
      bottom: -15px;
    }

    .grid div[data-layer="2"][data-audio="4"] div {
      top: 30px;
      right: 30px;
    }

    .grid div[data-layer="2"][data-audio="6"] div {
      top: 30px;
      left: 30px;
    }

    .grid div[data-layer="2"][data-audio="7"] div {
      top: -15px;
      right: -15px;
    }

    .grid div[data-layer="2"][data-audio="8"] div {
      top: 30px;
      left: 30px;
    }

    .grid div[data-layer="2"][data-audio="9"] div {
      top: -15px;
      left: -15px;
    }

    .grid div[data-layer="3"][data-audio="1"] div {
      bottom: 45px;
      right: 45px;
    }

    .grid div[data-layer="3"][data-audio="2"] div {
      left: 30px;
      bottom: 105px;
    }

    .grid div[data-layer="3"][data-audio="3"] div {
      left: 45px;
      bottom: 45px;
    }

    .grid div[data-layer="3"][data-audio="4"] div {
      top: 30px;
      right: 105px;
    }

    .grid div[data-layer="3"][data-audio="6"] div {
      top: 30px;
      left: 105px;
    }

    .grid div[data-layer="3"][data-audio="7"] div {
      top: 45px;
      right: 45px;
    }

    .grid div[data-layer="3"][data-audio="8"] div {
      top: 105px;
      left: 30px;
    }

    .grid div[data-layer="3"][data-audio="9"] div {
      top: 45px;
      left: 45px;
    }

    .grid .droplet {
      height: 60px;
      width: 60px;
      border: 20px solid var(--color-primary);
      background-color: var(--color-background);
      display: flex;
      position: relative;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .droplet:hover {
      background-color: var(--color-surface);
    }

    .grid div[data-audio="0"] {
      z-index: -100;
      opacity: 0;
    }

    .grid div.clicked {
      background-color: black;
    }

    .save-button {
      cursor: pointer;
      margin-top: 220px;
      width: auto;
      padding: 10px 20px;
      background: var(--color-accent);
      text-decoration: none;
      font-weight: 200;
      font-size: 17px;
      color: white;
      border: none;
      border-radius: 10px;
      transition: background-color 0.2s;
    }

    .save-button:hover {
      background: var(--color-accent-dark);
    }
  </style>
</head>
<body>
  <!-- Theme Toggle Button -->
  <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
    <span class="toggle-icon">ðŸ”„</span>
  </button>

  <div class="grid" id="grid">
    <div data-row="0" data-col="0" data-layer="3" data-audio="1"><div></div></div>
    <div data-row="0" data-col="1" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="0" data-col="2" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="0" data-col="3" data-layer="3" data-audio="2"><div></div></div>
    <div data-row="0" data-col="4" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="0" data-col="5" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="0" data-col="6" data-layer="3" data-audio="3"><div></div></div>
    <div data-row="1" data-col="0" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="1" data-col="1" data-layer="2" data-audio="1"><div></div></div>
    <div data-row="1" data-col="2" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="1" data-col="3" data-layer="2" data-audio="2"><div></div></div>
    <div data-row="1" data-col="4" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="1" data-col="5" data-layer="2" data-audio="3"><div></div></div>
    <div data-row="1" data-col="6" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="2" data-col="0" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="2" data-col="1" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="2" data-col="2" data-layer="1" data-audio="1"><div></div></div>
    <div data-row="2" data-col="3" data-layer="1" data-audio="2"><div></div></div>
    <div data-row="2" data-col="4" data-layer="1" data-audio="3"><div></div></div>
    <div data-row="2" data-col="5" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="2" data-col="6" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="3" data-col="0" data-layer="3" data-audio="4"><div></div></div>
    <div data-row="3" data-col="1" data-layer="2" data-audio="4"><div></div></div>
    <div data-row="3" data-col="2" data-layer="1" data-audio="4"><div></div></div>
    <div data-row="3" data-col="3" data-layer="0" data-audio="5" class="droplet clickableCircle" id="clickableCircle"></div>
    <div data-row="3" data-col="4" data-layer="1" data-audio="6"><div></div></div>
    <div data-row="3" data-col="5" data-layer="2" data-audio="6"><div></div></div>
    <div data-row="3" data-col="6" data-layer="3" data-audio="6"><div></div></div>
    <div data-row="4" data-col="0" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="4" data-col="1" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="4" data-col="2" data-layer="1" data-audio="7"><div></div></div>
    <div data-row="4" data-col="3" data-layer="1" data-audio="8"><div></div></div>
    <div data-row="4" data-col="4" data-layer="1" data-audio="9"><div></div></div>
    <div data-row="4" data-col="5" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="4" data-col="6" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="5" data-col="0" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="5" data-col="1" data-layer="2" data-audio="7"><div></div></div>
    <div data-row="5" data-col="2" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="5" data-col="3" data-layer="2" data-audio="8"><div></div></div>
    <div data-row="5" data-col="4" data-layer="2" data-audio="0"><div></div></div>
    <div data-row="5" data-col="5" data-layer="2" data-audio="9"><div></div></div>
    <div data-row="5" data-col="6" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="6" data-col="0" data-layer="3" data-audio="7"><div></div></div>
    <div data-row="6" data-col="1" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="6" data-col="2" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="6" data-col="3" data-layer="3" data-audio="8"><div></div></div>
    <div data-row="6" data-col="4" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="6" data-col="5" data-layer="3" data-audio="0"><div></div></div>
    <div data-row="6" data-col="6" data-layer="3" data-audio="9"><div></div></div>
  </div>
  <button class="save-button" id="save">Save Sequence</button>  <script>
    // Theme Storage using IndexedDB
    class ThemeStorage {
      constructor() {
        this.dbName = 'ClickingGlossaliaDB';
        this.dbVersion = 1;
        this.storeName = 'preferences';
        this.db = null;
      }

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.dbVersion);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.db = request.result;
            resolve(this.db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(this.storeName)) {
              const store = db.createObjectStore(this.storeName, { keyPath: 'key' });
            }
          };
        });
      }

      async setTheme(theme) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.storeName], 'readwrite');
          const store = transaction.objectStore(this.storeName);
          const request = store.put({ key: 'themePreference', value: theme });

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve();
        });
      }

      async getTheme() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([this.storeName], 'readonly');
          const store = transaction.objectStore(this.storeName);
          const request = store.get('themePreference');

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.value : 'system');
          };
        });
      }
    }

    // Create global theme storage instance
    const themeStorage = new ThemeStorage();

    // Theme Toggle Functionality (dark | system | light)
    async function initializeTheme() {
      try {
        const savedTheme = await themeStorage.getTheme();
        applyTheme(savedTheme);
      } catch (error) {
        console.warn('Failed to load theme from IndexedDB, falling back to system:', error);
        const fallbackTheme = localStorage.getItem('themePreference') || 'system';
        applyTheme(fallbackTheme);
      }
    }

    function applyTheme(theme) {
      const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

      document.body.classList.remove('dark-mode', 'light-mode');

      switch(theme) {
        case 'dark':
          document.body.classList.add('dark-mode');
          break;
        case 'light':
          document.body.classList.add('light-mode');
          break;
        case 'system':
        default:
          if (prefersDarkMode) {
            document.body.classList.add('dark-mode');
          } else {
            document.body.classList.add('light-mode');
          }
          break;
      }

      updateToggleIcon(theme);
    }

    async function toggleTheme() {
      try {
        const currentTheme = await themeStorage.getTheme();
        let nextTheme;

        switch(currentTheme) {
          case 'system':
            nextTheme = 'light';
            break;
          case 'light':
            nextTheme = 'dark';
            break;
          case 'dark':
            nextTheme = 'system';
            break;
          default:
            nextTheme = 'system';
        }

        await themeStorage.setTheme(nextTheme);
        localStorage.setItem('themePreference', nextTheme);

        applyTheme(nextTheme);
      } catch (error) {
        console.warn('Failed to save theme to IndexedDB:', error);
        // Fallback to localStorage-only operation
        const currentTheme = localStorage.getItem('themePreference') || 'system';
        let nextTheme;

        switch(currentTheme) {
          case 'system':
            nextTheme = 'light';
            break;
          case 'light':
            nextTheme = 'dark';
            break;
          case 'dark':
            nextTheme = 'system';
            break;
          default:
            nextTheme = 'system';
        }

        localStorage.setItem('themePreference', nextTheme);
        applyTheme(nextTheme);
      }
    }

    function updateToggleIcon(theme) {
      const toggleButton = document.getElementById('themeToggle');
      if (toggleButton) {
        const toggleIcon = toggleButton.querySelector('.toggle-icon');
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

        switch(theme) {
          case 'dark':
            toggleIcon.textContent = 'â˜€ï¸';
            toggleButton.title = 'Switch to system theme';
            break;
          case 'light':
            toggleIcon.textContent = 'ðŸŒ™';
            toggleButton.title = 'Switch to dark theme';
            break;
          case 'system':
          default:
            toggleIcon.textContent = 'ðŸ”„';
            toggleButton.title = 'Switch to light theme';
            break;
        }
      }
    }

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeTheme();
    });

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', async (e) => {
      try {
        const currentTheme = await themeStorage.getTheme();
        if (currentTheme === 'system') {
          applyTheme('system');
        }
      } catch (error) {
        const currentTheme = localStorage.getItem('themePreference') || 'system';
        if (currentTheme === 'system') {
          applyTheme('system');
        }
      }
    });
  </script>

  <script src="./js/new_word.js"></script>
</body>
</html>
